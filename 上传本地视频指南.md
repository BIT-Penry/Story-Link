# 📹 上传本地视频到故事 - 完整指南

## 🎯 目标
将本地视频文件上传并替换"荒野猎人"故事中的视频

## 📋 当前情况
- **故事 ID**: 5
- **故事标题**: 荒野猎人
- **作者**: ssh
- **当前视频**: `/videos/mock_video.mp4` (Mock 视频)
- **视频状态**: completed

---

## 🚀 方法一：手动替换（推荐，最简单）

### 步骤 1: 准备你的视频文件
确保你的视频文件：
- ✅ 格式为 `.mp4`
- ✅ 文件大小合理（建议 < 100MB）
- ✅ 分辨率推荐 16:9（如 1920x1080）

### 步骤 2: 复制视频到项目目录

```bash
# 假设你的本地视频路径是 ~/Downloads/my_video.mp4
# 将它复制到项目的 videos 目录，并重命名

cp ~/Downloads/my_video.mp4 "/Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend/videos/story_5_custom.mp4"
```

**⚠️ 重要**：
- 文件名建议使用 `story_5_custom.mp4` 格式
- `5` 是故事的 ID
- 确保文件名中没有空格或特殊字符

### 步骤 3: 更新数据库

```bash
# 进入 backend 目录
cd "/Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend"

# 更新数据库中的视频路径
sqlite3 moviehub.db "UPDATE stories SET video_url = '/videos/story_5_custom.mp4', video_status = 'completed' WHERE id = 5"

# 验证更新
sqlite3 moviehub.db "SELECT id, title, video_url, video_status FROM stories WHERE id = 5"
```

### 步骤 4: 刷新前端页面
在浏览器中刷新页面（http://localhost:5173），你应该能看到新的视频！

---

## 🚀 方法二：一键脚本（自动化）

创建一个快捷脚本来简化操作：

### 创建上传脚本

```bash
cat > "/Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend/upload_video.sh" << 'EOF'
#!/bin/bash

# 上传本地视频到指定故事
# 用法: ./upload_video.sh <story_id> <视频文件路径>

if [ "$#" -ne 2 ]; then
    echo "用法: $0 <story_id> <视频文件路径>"
    echo "示例: $0 5 ~/Downloads/my_video.mp4"
    exit 1
fi

STORY_ID=$1
VIDEO_PATH=$2
DB_PATH="moviehub.db"
VIDEO_DIR="videos"

# 检查视频文件是否存在
if [ ! -f "$VIDEO_PATH" ]; then
    echo "❌ 错误: 视频文件不存在: $VIDEO_PATH"
    exit 1
fi

# 检查文件扩展名
if [[ ! "$VIDEO_PATH" =~ \.mp4$ ]]; then
    echo "❌ 错误: 视频文件必须是 .mp4 格式"
    exit 1
fi

# 生成目标文件名
TIMESTAMP=$(date +%s)
TARGET_FILE="story_${STORY_ID}_${TIMESTAMP}.mp4"
TARGET_PATH="${VIDEO_DIR}/${TARGET_FILE}"

# 复制视频文件
echo "📹 复制视频文件..."
cp "$VIDEO_PATH" "$TARGET_PATH"

if [ $? -ne 0 ]; then
    echo "❌ 复制失败"
    exit 1
fi

echo "✅ 视频已复制到: $TARGET_PATH"

# 更新数据库
echo "🗄️  更新数据库..."
sqlite3 "$DB_PATH" "UPDATE stories SET video_url = '/videos/${TARGET_FILE}', video_status = 'completed' WHERE id = ${STORY_ID}"

if [ $? -ne 0 ]; then
    echo "❌ 数据库更新失败"
    exit 1
fi

echo "✅ 数据库更新成功"

# 验证更新
echo ""
echo "📊 当前故事视频信息:"
sqlite3 "$DB_PATH" "SELECT id, title, video_url, video_status FROM stories WHERE id = ${STORY_ID}"

echo ""
echo "🎉 视频上传成功！刷新浏览器即可观看。"
EOF

# 添加执行权限
chmod +x "/Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend/upload_video.sh"
```

### 使用脚本

```bash
cd "/Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend"

# 上传视频到故事 ID 5（荒野猎人）
./upload_video.sh 5 ~/Downloads/my_video.mp4
```

---

## 🎬 方法三：通过 Python 脚本（程序化）

创建一个 Python 脚本来管理视频上传：

```python
# upload_video.py
import os
import sys
import sqlite3
import shutil
from pathlib import Path
from datetime import datetime

def upload_video(story_id: int, video_path: str):
    """上传视频到指定故事"""
    
    # 检查视频文件
    video_file = Path(video_path)
    if not video_file.exists():
        print(f"❌ 错误: 视频文件不存在: {video_path}")
        return False
    
    if video_file.suffix.lower() != '.mp4':
        print(f"❌ 错误: 视频文件必须是 .mp4 格式")
        return False
    
    # 准备目标路径
    video_dir = Path("videos")
    video_dir.mkdir(exist_ok=True)
    
    timestamp = int(datetime.now().timestamp())
    target_filename = f"story_{story_id}_{timestamp}.mp4"
    target_path = video_dir / target_filename
    
    # 复制视频
    print(f"📹 复制视频文件...")
    try:
        shutil.copy2(video_path, target_path)
        print(f"✅ 视频已复制到: {target_path}")
    except Exception as e:
        print(f"❌ 复制失败: {e}")
        return False
    
    # 更新数据库
    print(f"🗄️  更新数据库...")
    try:
        conn = sqlite3.connect("moviehub.db")
        cursor = conn.cursor()
        
        cursor.execute(
            "UPDATE stories SET video_url = ?, video_status = 'completed' WHERE id = ?",
            (f"/videos/{target_filename}", story_id)
        )
        
        conn.commit()
        
        # 验证更新
        cursor.execute(
            "SELECT id, title, video_url, video_status FROM stories WHERE id = ?",
            (story_id,)
        )
        result = cursor.fetchone()
        
        print(f"✅ 数据库更新成功")
        print(f"\n📊 当前故事视频信息:")
        print(f"ID: {result[0]}")
        print(f"标题: {result[1]}")
        print(f"视频URL: {result[2]}")
        print(f"状态: {result[3]}")
        
        conn.close()
        
    except Exception as e:
        print(f"❌ 数据库更新失败: {e}")
        return False
    
    print(f"\n🎉 视频上传成功！刷新浏览器即可观看。")
    return True

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("用法: python upload_video.py <story_id> <视频文件路径>")
        print("示例: python upload_video.py 5 ~/Downloads/my_video.mp4")
        sys.exit(1)
    
    story_id = int(sys.argv[1])
    video_path = sys.argv[2]
    
    upload_video(story_id, video_path)
```

### 使用 Python 脚本

```bash
cd "/Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend"

# 上传视频
python3 upload_video.py 5 ~/Downloads/my_video.mp4
```

---

## 🔍 验证视频是否替换成功

### 1. 检查文件是否存在
```bash
ls -lh "/Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend/videos/"
```

### 2. 检查数据库记录
```bash
cd "/Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend"
sqlite3 moviehub.db "SELECT id, title, video_url, video_status FROM stories WHERE id = 5"
```

应该看到类似输出：
```
5|荒野猎人|ssh|/videos/story_5_1761459856.mp4|completed
```

### 3. 在浏览器中测试
1. 访问 http://localhost:5173
2. 找到"荒野猎人"故事卡片
3. 点击"查看详情"
4. 视频播放器应该显示你上传的视频

---

## ⚠️ 常见问题

### Q1: 视频不显示怎么办？
**A**: 检查以下几点：
1. 确保后端服务正在运行（`python3 main.py`）
2. 清除浏览器缓存并刷新
3. 检查浏览器控制台是否有错误
4. 确认视频文件路径在数据库中正确

### Q2: 视频播放器显示错误？
**A**: 可能的原因：
1. 视频格式不兼容 - 确保是 H.264 编码的 MP4
2. 文件权限问题 - 确保文件可读
3. 视频文件损坏 - 尝试用其他播放器测试

### Q3: 如何转换视频格式？
**A**: 使用 ffmpeg 转换：
```bash
# 安装 ffmpeg (如果没有)
brew install ffmpeg

# 转换视频为兼容格式
ffmpeg -i input.mov -c:v libx264 -c:a aac -movflags +faststart output.mp4
```

### Q4: 如何批量上传多个视频？
**A**: 使用循环脚本：
```bash
# 批量上传
for story_id in 5 6 7; do
    ./upload_video.sh $story_id ~/Downloads/video_${story_id}.mp4
done
```

---

## 🎯 快速上传（复制粘贴即用）

假设你的视频在 `~/Downloads/my_video.mp4`，执行以下命令：

```bash
# 一键替换荒野猎人的视频
cd "/Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend"

# 复制视频
cp ~/Downloads/my_video.mp4 videos/story_5_custom.mp4

# 更新数据库
sqlite3 moviehub.db "UPDATE stories SET video_url = '/videos/story_5_custom.mp4', video_status = 'completed' WHERE id = 5"

# 验证
sqlite3 moviehub.db "SELECT id, title, video_url FROM stories WHERE id = 5"

echo "✅ 完成！刷新浏览器页面查看新视频"
```

---

## 📚 相关文件位置

- **视频目录**: `backend/videos/`
- **数据库**: `backend/moviehub.db`
- **后端API**: `backend/main.py`
- **视频播放组件**: `frontend/src/pages/StoryDetailPage.jsx`

---

## ✨ 提示

1. **视频命名规范**: `story_{id}_{timestamp}.mp4`
2. **推荐分辨率**: 1920x1080 (16:9)
3. **推荐时长**: 15-30 秒
4. **文件大小**: 建议 < 100MB
5. **编码格式**: H.264 (最兼容)

---

现在你可以开始上传你的本地视频了！🎬

