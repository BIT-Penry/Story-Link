# 🧪 协作续写功能测试指南

## 🎯 功能概述

已成功将**Fork独立故事**模式改为**协作续写**模式：

### 改动前 ❌
- 续写创建新的独立故事
- 首页显示多个版本的故事
- 视频只包含单个用户的内容

### 改动后 ✅
- 续写**添加到原故事**
- 首页只显示**原创故事**
- 视频包含**所有续写者的完整内容**
- 只有**原作者**可以生成视频

---

## 📋 测试场景

### 场景1: 创建原创故事

1. **操作步骤**:
   - 用户 `ssh` 登录（设置昵称）
   - 点击"写新故事"
   - 创建故事《中关村》，写一段内容
   - 设置允许续写人数为 5
   - 保存（不生成视频）

2. **预期结果**:
   - ✅ 故事立即出现在首页
   - ✅ 显示 `0/5 人续写`
   - ✅ 视频状态为 `none`（不显示生成中）

---

### 场景2: 用户B续写故事

1. **操作步骤**:
   - 用户 `B` 登录（设置昵称）
   - 在首页点击《中关村》
   - 点击"Fork 并续写"
   - 添加自己的续写内容
   - 保存

2. **预期结果**:
   - ✅ 首页**仍然只显示一个**《中关村》故事
   - ✅ 续写计数更新为 `1/5 人续写`
   - ✅ 详情页显示：
     - 原作者 `ssh` 的内容
     - 续写者 `B` 的内容（带蓝色边框）
   - ✅ `B` **无法**看到"生成视频"按钮

---

### 场景3: 用户C、D继续续写

1. **操作步骤**:
   - 用户 `C` 和 `D` 分别登录
   - 都对《中关村》进行续写

2. **预期结果**:
   - ✅ 首页仍然只有**一个**《中关村》
   - ✅ 续写计数变为 `3/5 人续写`
   - ✅ 详情页按时间顺序显示：
     - ssh 的原创
     - B 的续写 #1
     - C 的续写 #2
     - D 的续写 #3

---

### 场景4: 原作者生成视频

1. **操作步骤**:
   - 用户 `ssh` 登录
   - 打开《中关村》详情页
   - 点击"生成视频（含3个续写）"
   - 确认生成

2. **预期结果**:
   - ✅ 提示："视频生成已开始（包含3个续写），请稍后查看！"
   - ✅ 视频状态变为 `generating`
   - ✅ 首页显示"⏳ 生成中"标签
   - ✅ 视频生成使用的内容：
     ```
     ssh的内容
     
     B的内容
     
     C的内容
     
     D的内容
     ```

---

### 场景5: 非原作者尝试生成视频

1. **操作步骤**:
   - 用户 `B` 登录
   - 打开《中关村》详情页

2. **预期结果**:
   - ✅ **看不到**"生成视频"按钮
   - ✅ 显示提示：`ℹ️ 只有原作者 ssh 可以生成视频 (视频将包含所有3个续写)`

---

### 场景6: 达到续写上限

1. **操作步骤**:
   - 用户 `E` 和 `F` 继续续写
   - 用户 `G` 尝试续写（第6个人）

2. **预期结果**:
   - ✅ 续写计数达到 `5/5 人续写`
   - ✅ "Fork 并续写"按钮变灰
   - ✅ 点击提示："该故事已达到续写人数上限（5/5）"

---

### 场景7: AI润色使用完整内容

1. **操作步骤**:
   - 任意用户打开《中关村》详情页
   - 点击"🤖 AI 润色"

2. **预期结果**:
   - ✅ 润色的是**完整内容**（ssh + B + C + D + E）
   - ✅ 显示提示："✨ 这是 AI 润色后的完整故事版本（包含所有续写）"

---

### 场景8: 首页筛选功能

1. **操作步骤**:
   - 在首页切换筛选：
     - 📖 全部故事
     - 🎥 有视频

2. **预期结果**:
   - ✅ "全部故事" - 显示所有原创故事（续写不单独显示）
   - ✅ "有视频" - 只显示 `video_status = 'completed'` 的故事
   - ✅ 移除了"原创故事"和"续写故事"筛选项

---

## 🔍 关键检查点

### 数据库层面

```sql
-- 查询原创故事
SELECT * FROM stories WHERE parent_id IS NULL;

-- 查询某个故事的所有续写
SELECT * FROM stories WHERE parent_id = 1 ORDER BY created_at ASC;

-- 验证续写计数
SELECT title, author, fork_count, max_contributors FROM stories WHERE parent_id IS NULL;
```

### API层面

```bash
# 获取故事列表（只返回原创）
curl http://localhost:8000/api/stories?filter_by=all

# 获取完整故事内容
curl http://localhost:8000/api/stories/1/full-content

# 生成视频（需要原作者身份）
curl -X POST http://localhost:8000/api/stories/1/generate-video \
  -H "Content-Type: application/json" \
  -d '{"author": "ssh"}'
```

### 前端层面

1. **首页检查**:
   - 只显示原创故事
   - 显示续写计数 `X/Y 人续写`
   - 不显示"原创"/"续写"标签

2. **详情页检查**:
   - 原创内容在顶部
   - 续写内容按时间排序，带序号
   - "生成视频"按钮只有原作者可见
   - 视频按钮显示续写数量

---

## 🎬 完整用户流程演示

### 时间线示例

```
T1: ssh 创建《中关村》
    首页: [《中关村》 - ssh · 0/5 人续写]

T2: B 续写
    首页: [《中关村》 - ssh · 1/5 人续写]
    详情: ssh原创 + B续写#1

T3: C 续写
    首页: [《中关村》 - ssh · 2/5 人续写]
    详情: ssh原创 + B续写#1 + C续写#2

T4: ssh 生成视频
    首页: [《中关村》 - ssh · ⏳ 生成中]
    prompt: ssh内容 + B内容 + C内容

T5: 视频生成完成
    首页: [《中关村》 - ssh · 🎥 有视频 · 2/5 人续写]
    详情: 显示视频播放器（包含所有人的内容）
```

---

## 🐛 常见问题

### Q1: 续写后首页还是显示多个故事？
**A**: 检查后端 `get_stories` 接口是否添加了 `WHERE parent_id IS NULL` 条件。

### Q2: 视频只包含原作者内容？
**A**: 检查 `generate_video_for_story` 接口是否查询并合并了所有续写内容。

### Q3: 非原作者也能看到"生成视频"按钮？
**A**: 检查前端 `StoryDetailPage.jsx` 的条件：`fullStory.original_author === userNickname`。

### Q4: 续写计数不更新？
**A**: 检查 `create_story` 接口是否在创建续写时增加了父故事的 `fork_count`。

---

## ✅ 验收标准

- [ ] 首页只显示原创故事（不显示续写）
- [ ] 详情页按顺序显示原创+所有续写
- [ ] 只有原作者能生成视频
- [ ] 视频使用完整内容（原创+所有续写）
- [ ] AI润色使用完整内容
- [ ] 续写计数准确显示
- [ ] 达到上限时无法续写
- [ ] 所有UI提示正确显示续写人数

---

## 🚀 测试步骤快速上手

1. **启动服务**:
   ```bash
   cd /Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link
   ./start.sh
   ```

2. **打开浏览器**:
   ```
   http://localhost:5173
   ```

3. **测试流程**:
   - 第一个浏览器窗口：用户 `ssh` 创建故事
   - 第二个浏览器窗口（隐身模式）：用户 `B` 续写
   - 第三个浏览器窗口（隐身模式）：用户 `C` 续写
   - 回到第一个窗口：`ssh` 生成视频

4. **观察结果**:
   - 首页始终只有一个《中关村》
   - 详情页显示所有人的内容
   - 只有 `ssh` 能生成视频
   - 视频包含所有人的内容

---

祝测试顺利！ 🎉

