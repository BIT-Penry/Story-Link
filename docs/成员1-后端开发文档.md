# ğŸ”§ åç«¯å¼€å‘æ–‡æ¡£ - æˆå‘˜1

**å¼€å‘è€…**: åç«¯å·¥ç¨‹å¸ˆ  
**åˆ†æ”¯åç§°**: `feat/backend-api-<ä½ çš„åå­—>`  
**å¼€å‘å‘¨æœŸ**: 1-2å¤©  
**æ ¸å¿ƒèŒè´£**: APIä¼˜åŒ–ã€æ•°æ®åº“æ‰©å±•ã€æ€§èƒ½æå‡

---

## ğŸ“‹ ä»»åŠ¡æ¸…å•

### ä¼˜å…ˆçº§ P0 (å¿…é¡»å®Œæˆ)

- [ ] å®ç°è¯„è®ºæ¥å£ (GET/POST)
- [ ] å®ç°ç‚¹èµæ¥å£ (POST/DELETE)
- [ ] æ·»åŠ æ•…äº‹ç­›é€‰å’Œæ’åºåŠŸèƒ½
- [ ] å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- [ ] æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ–

### ä¼˜å…ˆçº§ P1 (å¼ºçƒˆå»ºè®®)

- [ ] å®ç°ç®€å•ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- [ ] æ·»åŠ æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æ€§èƒ½
- [ ] å®ç°è§†é¢‘ç”Ÿæˆé˜Ÿåˆ—ç®¡ç†
- [ ] æ·»åŠ APIå“åº”ç¼“å­˜

### ä¼˜å…ˆçº§ P2 (æ—¶é—´å……è£•æ—¶)

- [ ] å®ç°æœç´¢åŠŸèƒ½
- [ ] æ·»åŠ æ•…äº‹åˆ†ç±»/æ ‡ç­¾
- [ ] å®ç°æ•°æ®ç»Ÿè®¡æ¥å£

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. æ‰©å±• stories è¡¨

```sql
-- åœ¨ç°æœ‰è¡¨åŸºç¡€ä¸Šæ·»åŠ å­—æ®µ
ALTER TABLE stories ADD COLUMN likes_count INTEGER DEFAULT 0;
ALTER TABLE stories ADD COLUMN comments_count INTEGER DEFAULT 0;
ALTER TABLE stories ADD COLUMN views_count INTEGER DEFAULT 0;
ALTER TABLE stories ADD COLUMN tags TEXT DEFAULT '';
ALTER TABLE stories ADD COLUMN category TEXT DEFAULT 'general';
ALTER TABLE stories ADD COLUMN user_id INTEGER DEFAULT 0;

-- æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_stories_approved ON stories(is_approved);
CREATE INDEX idx_stories_created_at ON stories(created_at DESC);
CREATE INDEX idx_stories_likes ON stories(likes_count DESC);
CREATE INDEX idx_stories_parent_id ON stories(parent_id);
```

### 2. åˆ›å»º comments è¡¨

```sql
CREATE TABLE IF NOT EXISTS comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    story_id INTEGER NOT NULL,
    author TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
);

CREATE INDEX idx_comments_story_id ON comments(story_id);
CREATE INDEX idx_comments_created_at ON comments(created_at DESC);
```

### 3. åˆ›å»º likes è¡¨

```sql
CREATE TABLE IF NOT EXISTS likes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    story_id INTEGER NOT NULL,
    user_identifier TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(story_id, user_identifier),
    FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
);

CREATE INDEX idx_likes_story_id ON likes(story_id);
CREATE INDEX idx_likes_user ON likes(user_identifier);
```

### 4. åˆ›å»º users è¡¨ï¼ˆå¯é€‰ï¼‰

```sql
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    nickname TEXT NOT NULL,
    password_hash TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_username ON users(username);
```

---

## ğŸ”Œ API æ¥å£è§„èŒƒ

### åŸºç¡€URL
```
http://localhost:8000/api
```

---

### 1. è¯„è®ºç›¸å…³æ¥å£

#### 1.1 è·å–æ•…äº‹çš„è¯„è®ºåˆ—è¡¨

**æ¥å£**: `GET /api/stories/{story_id}/comments`

**è¯·æ±‚å‚æ•°**:
- `story_id` (è·¯å¾„å‚æ•°): æ•…äº‹ID
- `limit` (æŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰): è¿”å›æ•°é‡ï¼Œé»˜è®¤50
- `offset` (æŸ¥è¯¢å‚æ•°ï¼Œå¯é€‰): åç§»é‡ï¼Œé»˜è®¤0

**å“åº”ç¤ºä¾‹**:
```json
{
  "total": 23,
  "comments": [
    {
      "id": 1,
      "story_id": 5,
      "author": "å¼ ä¸‰",
      "content": "å†™å¾—çœŸå¥½ï¼æœŸå¾…ç»­é›†ï¼",
      "created_at": "2025-10-26T10:30:00"
    },
    {
      "id": 2,
      "story_id": 5,
      "author": "æå››",
      "content": "æƒ…èŠ‚å¾ˆæœ‰å¼ åŠ›ï¼Œèµï¼",
      "created_at": "2025-10-26T11:15:00"
    }
  ]
}
```

**å®ç°ä»£ç **:
```python
@app.get("/api/stories/{story_id}/comments")
def get_comments(story_id: int, limit: int = 50, offset: int = 0):
    """è·å–æ•…äº‹è¯„è®ºåˆ—è¡¨"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # æ£€æŸ¥æ•…äº‹æ˜¯å¦å­˜åœ¨
        cursor.execute("SELECT id FROM stories WHERE id = ?", (story_id,))
        if not cursor.fetchone():
            raise HTTPException(status_code=404, detail="æ•…äº‹ä¸å­˜åœ¨")
        
        # è·å–æ€»æ•°
        cursor.execute(
            "SELECT COUNT(*) as total FROM comments WHERE story_id = ?",
            (story_id,)
        )
        total = cursor.fetchone()["total"]
        
        # è·å–è¯„è®ºåˆ—è¡¨
        cursor.execute(
            """
            SELECT id, story_id, author, content, created_at 
            FROM comments 
            WHERE story_id = ? 
            ORDER BY created_at DESC 
            LIMIT ? OFFSET ?
            """,
            (story_id, limit, offset)
        )
        rows = cursor.fetchall()
        conn.close()
        
        return {
            "total": total,
            "comments": [dict_from_row(row) for row in rows]
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"è·å–è¯„è®ºå¤±è´¥: {str(e)}")
```

#### 1.2 å‘è¡¨è¯„è®º

**æ¥å£**: `POST /api/stories/{story_id}/comments`

**è¯·æ±‚ä½“**:
```json
{
  "author": "å¼ ä¸‰",
  "content": "å†™å¾—çœŸå¥½ï¼æœŸå¾…ç»­é›†ï¼"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": 1,
  "story_id": 5,
  "author": "å¼ ä¸‰",
  "content": "å†™å¾—çœŸå¥½ï¼æœŸå¾…ç»­é›†ï¼",
  "created_at": "2025-10-26T10:30:00"
}
```

**å®ç°ä»£ç **:
```python
class CommentCreate(BaseModel):
    author: str
    content: str

@app.post("/api/stories/{story_id}/comments")
def create_comment(story_id: int, comment: CommentCreate):
    """å‘è¡¨è¯„è®º"""
    try:
        # éªŒè¯è¾“å…¥
        if not comment.author.strip():
            raise HTTPException(status_code=400, detail="ä½œè€…æ˜µç§°ä¸èƒ½ä¸ºç©º")
        if not comment.content.strip():
            raise HTTPException(status_code=400, detail="è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º")
        if len(comment.content) > 500:
            raise HTTPException(status_code=400, detail="è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡500å­—")
        
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # æ£€æŸ¥æ•…äº‹æ˜¯å¦å­˜åœ¨
        cursor.execute("SELECT id FROM stories WHERE id = ?", (story_id,))
        if not cursor.fetchone():
            conn.close()
            raise HTTPException(status_code=404, detail="æ•…äº‹ä¸å­˜åœ¨")
        
        # æ’å…¥è¯„è®º
        cursor.execute(
            """
            INSERT INTO comments (story_id, author, content)
            VALUES (?, ?, ?)
            """,
            (story_id, comment.author, comment.content)
        )
        
        comment_id = cursor.lastrowid
        
        # æ›´æ–°æ•…äº‹çš„è¯„è®ºè®¡æ•°
        cursor.execute(
            """
            UPDATE stories 
            SET comments_count = comments_count + 1 
            WHERE id = ?
            """,
            (story_id,)
        )
        
        conn.commit()
        
        # è·å–åˆšåˆ›å»ºçš„è¯„è®º
        cursor.execute("SELECT * FROM comments WHERE id = ?", (comment_id,))
        row = cursor.fetchone()
        conn.close()
        
        return dict_from_row(row)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"å‘è¡¨è¯„è®ºå¤±è´¥: {str(e)}")
```

---

### 2. ç‚¹èµç›¸å…³æ¥å£

#### 2.1 è·å–æ•…äº‹ç‚¹èµæ•°

**æ¥å£**: `GET /api/stories/{story_id}/likes`

**å“åº”ç¤ºä¾‹**:
```json
{
  "story_id": 5,
  "likes_count": 42,
  "user_liked": false
}
```

**å®ç°ä»£ç **:
```python
@app.get("/api/stories/{story_id}/likes")
def get_likes(story_id: int, user_id: str = "anonymous"):
    """è·å–æ•…äº‹ç‚¹èµæ•°"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # è·å–ç‚¹èµæ€»æ•°
        cursor.execute(
            "SELECT likes_count FROM stories WHERE id = ?",
            (story_id,)
        )
        row = cursor.fetchone()
        if not row:
            conn.close()
            raise HTTPException(status_code=404, detail="æ•…äº‹ä¸å­˜åœ¨")
        
        likes_count = row["likes_count"]
        
        # æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ
        cursor.execute(
            "SELECT id FROM likes WHERE story_id = ? AND user_identifier = ?",
            (story_id, user_id)
        )
        user_liked = cursor.fetchone() is not None
        
        conn.close()
        
        return {
            "story_id": story_id,
            "likes_count": likes_count,
            "user_liked": user_liked
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"è·å–ç‚¹èµæ•°å¤±è´¥: {str(e)}")
```

#### 2.2 ç‚¹èµæ•…äº‹

**æ¥å£**: `POST /api/stories/{story_id}/like`

**è¯·æ±‚ä½“**:
```json
{
  "user_identifier": "user_123"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "message": "ç‚¹èµæˆåŠŸ",
  "likes_count": 43
}
```

**å®ç°ä»£ç **:
```python
class LikeRequest(BaseModel):
    user_identifier: str = "anonymous"

@app.post("/api/stories/{story_id}/like")
def like_story(story_id: int, like_req: LikeRequest):
    """ç‚¹èµæ•…äº‹"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # æ£€æŸ¥æ•…äº‹æ˜¯å¦å­˜åœ¨
        cursor.execute("SELECT id FROM stories WHERE id = ?", (story_id,))
        if not cursor.fetchone():
            conn.close()
            raise HTTPException(status_code=404, detail="æ•…äº‹ä¸å­˜åœ¨")
        
        # æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
        cursor.execute(
            "SELECT id FROM likes WHERE story_id = ? AND user_identifier = ?",
            (story_id, like_req.user_identifier)
        )
        if cursor.fetchone():
            conn.close()
            raise HTTPException(status_code=400, detail="æ‚¨å·²ç»ç‚¹èµè¿‡äº†")
        
        # æ’å…¥ç‚¹èµè®°å½•
        cursor.execute(
            "INSERT INTO likes (story_id, user_identifier) VALUES (?, ?)",
            (story_id, like_req.user_identifier)
        )
        
        # æ›´æ–°ç‚¹èµè®¡æ•°
        cursor.execute(
            "UPDATE stories SET likes_count = likes_count + 1 WHERE id = ?",
            (story_id,)
        )
        
        conn.commit()
        
        # è·å–æœ€æ–°ç‚¹èµæ•°
        cursor.execute("SELECT likes_count FROM stories WHERE id = ?", (story_id,))
        likes_count = cursor.fetchone()["likes_count"]
        
        conn.close()
        
        return {
            "message": "ç‚¹èµæˆåŠŸ",
            "likes_count": likes_count
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ç‚¹èµå¤±è´¥: {str(e)}")
```

#### 2.3 å–æ¶ˆç‚¹èµ

**æ¥å£**: `DELETE /api/stories/{story_id}/like`

**è¯·æ±‚ä½“**:
```json
{
  "user_identifier": "user_123"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "message": "å·²å–æ¶ˆç‚¹èµ",
  "likes_count": 42
}
```

**å®ç°ä»£ç **:
```python
@app.delete("/api/stories/{story_id}/like")
def unlike_story(story_id: int, like_req: LikeRequest):
    """å–æ¶ˆç‚¹èµ"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
        cursor.execute(
            "SELECT id FROM likes WHERE story_id = ? AND user_identifier = ?",
            (story_id, like_req.user_identifier)
        )
        if not cursor.fetchone():
            conn.close()
            raise HTTPException(status_code=400, detail="æ‚¨è¿˜æ²¡æœ‰ç‚¹èµè¿‡")
        
        # åˆ é™¤ç‚¹èµè®°å½•
        cursor.execute(
            "DELETE FROM likes WHERE story_id = ? AND user_identifier = ?",
            (story_id, like_req.user_identifier)
        )
        
        # æ›´æ–°ç‚¹èµè®¡æ•°
        cursor.execute(
            "UPDATE stories SET likes_count = likes_count - 1 WHERE id = ?",
            (story_id,)
        )
        
        conn.commit()
        
        # è·å–æœ€æ–°ç‚¹èµæ•°
        cursor.execute("SELECT likes_count FROM stories WHERE id = ?", (story_id,))
        likes_count = cursor.fetchone()["likes_count"]
        
        conn.close()
        
        return {
            "message": "å·²å–æ¶ˆç‚¹èµ",
            "likes_count": likes_count
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"å–æ¶ˆç‚¹èµå¤±è´¥: {str(e)}")
```

---

### 3. æ•…äº‹åˆ—è¡¨å¢å¼ºæ¥å£

#### 3.1 è·å–æ•…äº‹åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰å’Œæ’åºï¼‰

**æ¥å£**: `GET /api/stories`

**è¯·æ±‚å‚æ•°**:
- `approved_only` (bool): ä»…æ˜¾ç¤ºå·²æ‰¹å‡†çš„æ•…äº‹ï¼Œé»˜è®¤false
- `sort_by` (str): æ’åºå­—æ®µ (created_at/likes_count/comments_count)ï¼Œé»˜è®¤created_at
- `order` (str): æ’åºæ–¹å‘ (asc/desc)ï¼Œé»˜è®¤desc
- `limit` (int): è¿”å›æ•°é‡ï¼Œé»˜è®¤20
- `offset` (int): åç§»é‡ï¼Œé»˜è®¤0
- `category` (str): æ•…äº‹åˆ†ç±»ï¼Œå¯é€‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "total": 50,
  "stories": [
    {
      "id": 1,
      "title": "å¥‡å¹»ä¹‹æ—…",
      "author": "å¼ ä¸‰",
      "content": "å¾ˆä¹…å¾ˆä¹…ä»¥å‰...",
      "parent_id": null,
      "is_approved": true,
      "video_url": "/videos/story_1.mp4",
      "video_status": "completed",
      "likes_count": 42,
      "comments_count": 15,
      "views_count": 230,
      "tags": "å¥‡å¹»,å†’é™©",
      "category": "fantasy",
      "created_at": "2025-10-26T10:00:00"
    }
  ]
}
```

**å®ç°ä»£ç **:
```python
@app.get("/api/stories")
def get_stories(
    approved_only: bool = False,
    sort_by: str = "created_at",
    order: str = "desc",
    limit: int = 20,
    offset: int = 0,
    category: Optional[str] = None
):
    """è·å–æ•…äº‹åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰å’Œæ’åºï¼‰"""
    try:
        # éªŒè¯å‚æ•°
        valid_sort_fields = ["created_at", "likes_count", "comments_count", "views_count"]
        if sort_by not in valid_sort_fields:
            raise HTTPException(status_code=400, detail=f"æ— æ•ˆçš„æ’åºå­—æ®µ: {sort_by}")
        
        if order not in ["asc", "desc"]:
            raise HTTPException(status_code=400, detail="æ’åºæ–¹å‘å¿…é¡»æ˜¯ asc æˆ– desc")
        
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # æ„å»ºæŸ¥è¯¢æ¡ä»¶
        where_clauses = []
        params = []
        
        if approved_only:
            where_clauses.append("is_approved = 1")
        
        if category:
            where_clauses.append("category = ?")
            params.append(category)
        
        where_sql = " WHERE " + " AND ".join(where_clauses) if where_clauses else ""
        
        # è·å–æ€»æ•°
        cursor.execute(f"SELECT COUNT(*) as total FROM stories{where_sql}", params)
        total = cursor.fetchone()["total"]
        
        # è·å–æ•…äº‹åˆ—è¡¨
        query = f"""
            SELECT * FROM stories
            {where_sql}
            ORDER BY {sort_by} {order.upper()}
            LIMIT ? OFFSET ?
        """
        cursor.execute(query, params + [limit, offset])
        rows = cursor.fetchall()
        conn.close()
        
        return {
            "total": total,
            "stories": [dict_from_row(row) for row in rows]
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"è·å–æ•…äº‹åˆ—è¡¨å¤±è´¥: {str(e)}")
```

---

### 4. æœç´¢æ¥å£

#### 4.1 æœç´¢æ•…äº‹

**æ¥å£**: `GET /api/stories/search`

**è¯·æ±‚å‚æ•°**:
- `q` (str): æœç´¢å…³é”®è¯
- `limit` (int): è¿”å›æ•°é‡ï¼Œé»˜è®¤20

**å“åº”ç¤ºä¾‹**:
```json
{
  "total": 5,
  "stories": [...]
}
```

**å®ç°ä»£ç **:
```python
@app.get("/api/stories/search")
def search_stories(q: str, limit: int = 20):
    """æœç´¢æ•…äº‹ï¼ˆæ ‡é¢˜å’Œå†…å®¹ï¼‰"""
    try:
        if not q.strip():
            raise HTTPException(status_code=400, detail="æœç´¢å…³é”®è¯ä¸èƒ½ä¸ºç©º")
        
        conn = get_db_connection()
        cursor = conn.cursor()
        
        search_pattern = f"%{q}%"
        
        cursor.execute(
            """
            SELECT * FROM stories 
            WHERE (title LIKE ? OR content LIKE ?) AND is_approved = 1
            ORDER BY created_at DESC
            LIMIT ?
            """,
            (search_pattern, search_pattern, limit)
        )
        rows = cursor.fetchall()
        conn.close()
        
        return {
            "total": len(rows),
            "stories": [dict_from_row(row) for row in rows]
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"æœç´¢å¤±è´¥: {str(e)}")
```

---

## ğŸ”¨ å®Œæ•´å®ç°æ­¥éª¤

### æ­¥éª¤1: åˆ›å»ºæ–°çš„æ•°æ®åº“è¿ç§»å‡½æ•°

åœ¨ `backend/main.py` ä¸­æ·»åŠ ï¼š

```python
def migrate_db():
    """æ•°æ®åº“å‡çº§è¿ç§»"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    
    try:
        # æ£€æŸ¥å¹¶æ·»åŠ æ–°å­—æ®µ
        cursor.execute("PRAGMA table_info(stories)")
        columns = [col[1] for col in cursor.fetchall()]
        
        if "likes_count" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN likes_count INTEGER DEFAULT 0")
        if "comments_count" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN comments_count INTEGER DEFAULT 0")
        if "views_count" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN views_count INTEGER DEFAULT 0")
        if "tags" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN tags TEXT DEFAULT ''")
        if "category" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN category TEXT DEFAULT 'general'")
        
        # åˆ›å»ºè¯„è®ºè¡¨
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS comments (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                story_id INTEGER NOT NULL,
                author TEXT NOT NULL,
                content TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
            )
        """)
        
        # åˆ›å»ºç‚¹èµè¡¨
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS likes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                story_id INTEGER NOT NULL,
                user_identifier TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(story_id, user_identifier),
                FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
            )
        """)
        
        # åˆ›å»ºç´¢å¼•
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_stories_approved ON stories(is_approved)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_stories_created_at ON stories(created_at DESC)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_stories_likes ON stories(likes_count DESC)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_comments_story_id ON comments(story_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_likes_story_id ON likes(story_id)")
        
        conn.commit()
        print("âœ… æ•°æ®åº“è¿ç§»å®Œæˆ")
    except Exception as e:
        print(f"âŒ æ•°æ®åº“è¿ç§»å¤±è´¥: {e}")
        conn.rollback()
    finally:
        conn.close()

# åœ¨ init_db() åè°ƒç”¨
migrate_db()
```

### æ­¥éª¤2: æ·»åŠ æ‰€æœ‰æ–°çš„ Pydantic æ¨¡å‹

```python
class CommentCreate(BaseModel):
    author: str
    content: str

class CommentResponse(BaseModel):
    id: int
    story_id: int
    author: str
    content: str
    created_at: str

class LikeRequest(BaseModel):
    user_identifier: str = "anonymous"
```

### æ­¥éª¤3: æ·»åŠ æ‰€æœ‰æ–°æ¥å£

å°†ä¸Šé¢çš„æ¥å£å®ç°ä»£ç æ·»åŠ åˆ° `main.py` ä¸­ã€‚

### æ­¥éª¤4: æµ‹è¯•æ¥å£

ä½¿ç”¨ curl æˆ– Postman æµ‹è¯•ï¼š

```bash
# æµ‹è¯•å‘è¡¨è¯„è®º
curl -X POST http://localhost:8000/api/stories/1/comments \
  -H "Content-Type: application/json" \
  -d '{"author":"æµ‹è¯•ç”¨æˆ·","content":"è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®º"}'

# æµ‹è¯•è·å–è¯„è®º
curl http://localhost:8000/api/stories/1/comments

# æµ‹è¯•ç‚¹èµ
curl -X POST http://localhost:8000/api/stories/1/like \
  -H "Content-Type: application/json" \
  -d '{"user_identifier":"user_123"}'

# æµ‹è¯•è·å–ç‚¹èµæ•°
curl http://localhost:8000/api/stories/1/likes?user_id=user_123

# æµ‹è¯•æœç´¢
curl "http://localhost:8000/api/stories/search?q=å¥‡å¹»"
```

---

## ğŸ“ å¼€å‘è§„èŒƒ

### 1. ä»£ç è§„èŒƒ
- æ‰€æœ‰å‡½æ•°å¿…é¡»æœ‰ç±»å‹æ³¨è§£
- æ‰€æœ‰æ¥å£å¿…é¡»æœ‰é”™è¯¯å¤„ç†
- ä½¿ç”¨ try-except æ•è·å¼‚å¸¸
- æ•°æ®åº“æ“ä½œåå¿…é¡»å…³é—­è¿æ¥

### 2. æ—¥å¿—è§„èŒƒ
```python
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

logger.info(f"âœ… è¯„è®ºåˆ›å»ºæˆåŠŸ: comment_id={comment_id}")
logger.error(f"âŒ è¯„è®ºåˆ›å»ºå¤±è´¥: {str(e)}")
```

### 3. Git æäº¤è§„èŒƒ
```bash
git commit -m "feat: add comments API endpoints"
git commit -m "feat: add likes functionality"
git commit -m "feat: add story search API"
git commit -m "fix: handle duplicate like error"
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

- [ ] æ‰€æœ‰æ–°æ¥å£éƒ½èƒ½æ­£å¸¸å“åº”
- [ ] é”™è¯¯å¤„ç†è¦†ç›–æ‰€æœ‰å¼‚å¸¸æƒ…å†µ
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸï¼Œæ— æ•°æ®ä¸¢å¤±
- [ ] å¹¶å‘è¯·æ±‚ä¸ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- [ ] API æ–‡æ¡£å·²æ›´æ–°ï¼ˆ/docsï¼‰

---

## ğŸ“ è”ç³»æ–¹å¼

**é‡åˆ°é—®é¢˜è¯·è”ç³»**:
- è”è°ƒè´Ÿè´£äººï¼ˆæˆå‘˜4ï¼‰
- å‰ç«¯å¼€å‘ï¼ˆæˆå‘˜2ï¼‰éœ€è¦æ¥å£å¯¹æ¥

**å®Œæˆæ—¶é—´**: ç¬¬1å¤©ä¸‹åˆ 16:00 å‰å®Œæˆæ ¸å¿ƒæ¥å£

