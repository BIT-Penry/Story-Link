# 🔧 后端开发文档 - 成员1

**开发者**: 后端工程师  
**分支名称**: `feat/backend-api-<你的名字>`  
**开发周期**: 1-2天  
**核心职责**: API优化、数据库扩展、性能提升

---

## 📋 任务清单

### 优先级 P0 (必须完成)

- [ ] 实现评论接口 (GET/POST)
- [ ] 实现点赞接口 (POST/DELETE)
- [ ] 添加故事筛选和排序功能
- [ ] 完善错误处理和日志记录
- [ ] 数据库表结构优化

### 优先级 P1 (强烈建议)

- [ ] 实现简单用户认证系统
- [ ] 添加数据库索引优化性能
- [ ] 实现视频生成队列管理
- [ ] 添加API响应缓存

### 优先级 P2 (时间充裕时)

- [ ] 实现搜索功能
- [ ] 添加故事分类/标签
- [ ] 实现数据统计接口

---

## 🗄️ 数据库设计

### 1. 扩展 stories 表

```sql
-- 在现有表基础上添加字段
ALTER TABLE stories ADD COLUMN likes_count INTEGER DEFAULT 0;
ALTER TABLE stories ADD COLUMN comments_count INTEGER DEFAULT 0;
ALTER TABLE stories ADD COLUMN views_count INTEGER DEFAULT 0;
ALTER TABLE stories ADD COLUMN tags TEXT DEFAULT '';
ALTER TABLE stories ADD COLUMN category TEXT DEFAULT 'general';
ALTER TABLE stories ADD COLUMN user_id INTEGER DEFAULT 0;

-- 添加索引优化查询性能
CREATE INDEX idx_stories_approved ON stories(is_approved);
CREATE INDEX idx_stories_created_at ON stories(created_at DESC);
CREATE INDEX idx_stories_likes ON stories(likes_count DESC);
CREATE INDEX idx_stories_parent_id ON stories(parent_id);
```

### 2. 创建 comments 表

```sql
CREATE TABLE IF NOT EXISTS comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    story_id INTEGER NOT NULL,
    author TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
);

CREATE INDEX idx_comments_story_id ON comments(story_id);
CREATE INDEX idx_comments_created_at ON comments(created_at DESC);
```

### 3. 创建 likes 表

```sql
CREATE TABLE IF NOT EXISTS likes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    story_id INTEGER NOT NULL,
    user_identifier TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(story_id, user_identifier),
    FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
);

CREATE INDEX idx_likes_story_id ON likes(story_id);
CREATE INDEX idx_likes_user ON likes(user_identifier);
```

### 4. 创建 users 表（可选）

```sql
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    nickname TEXT NOT NULL,
    password_hash TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_username ON users(username);
```

---

## 🔌 API 接口规范

### 基础URL
```
http://localhost:8000/api
```

---

### 1. 评论相关接口

#### 1.1 获取故事的评论列表

**接口**: `GET /api/stories/{story_id}/comments`

**请求参数**:
- `story_id` (路径参数): 故事ID
- `limit` (查询参数，可选): 返回数量，默认50
- `offset` (查询参数，可选): 偏移量，默认0

**响应示例**:
```json
{
  "total": 23,
  "comments": [
    {
      "id": 1,
      "story_id": 5,
      "author": "张三",
      "content": "写得真好！期待续集！",
      "created_at": "2025-10-26T10:30:00"
    },
    {
      "id": 2,
      "story_id": 5,
      "author": "李四",
      "content": "情节很有张力，赞！",
      "created_at": "2025-10-26T11:15:00"
    }
  ]
}
```

**实现代码**:
```python
@app.get("/api/stories/{story_id}/comments")
def get_comments(story_id: int, limit: int = 50, offset: int = 0):
    """获取故事评论列表"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 检查故事是否存在
        cursor.execute("SELECT id FROM stories WHERE id = ?", (story_id,))
        if not cursor.fetchone():
            raise HTTPException(status_code=404, detail="故事不存在")
        
        # 获取总数
        cursor.execute(
            "SELECT COUNT(*) as total FROM comments WHERE story_id = ?",
            (story_id,)
        )
        total = cursor.fetchone()["total"]
        
        # 获取评论列表
        cursor.execute(
            """
            SELECT id, story_id, author, content, created_at 
            FROM comments 
            WHERE story_id = ? 
            ORDER BY created_at DESC 
            LIMIT ? OFFSET ?
            """,
            (story_id, limit, offset)
        )
        rows = cursor.fetchall()
        conn.close()
        
        return {
            "total": total,
            "comments": [dict_from_row(row) for row in rows]
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"获取评论失败: {str(e)}")
```

#### 1.2 发表评论

**接口**: `POST /api/stories/{story_id}/comments`

**请求体**:
```json
{
  "author": "张三",
  "content": "写得真好！期待续集！"
}
```

**响应示例**:
```json
{
  "id": 1,
  "story_id": 5,
  "author": "张三",
  "content": "写得真好！期待续集！",
  "created_at": "2025-10-26T10:30:00"
}
```

**实现代码**:
```python
class CommentCreate(BaseModel):
    author: str
    content: str

@app.post("/api/stories/{story_id}/comments")
def create_comment(story_id: int, comment: CommentCreate):
    """发表评论"""
    try:
        # 验证输入
        if not comment.author.strip():
            raise HTTPException(status_code=400, detail="作者昵称不能为空")
        if not comment.content.strip():
            raise HTTPException(status_code=400, detail="评论内容不能为空")
        if len(comment.content) > 500:
            raise HTTPException(status_code=400, detail="评论内容不能超过500字")
        
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 检查故事是否存在
        cursor.execute("SELECT id FROM stories WHERE id = ?", (story_id,))
        if not cursor.fetchone():
            conn.close()
            raise HTTPException(status_code=404, detail="故事不存在")
        
        # 插入评论
        cursor.execute(
            """
            INSERT INTO comments (story_id, author, content)
            VALUES (?, ?, ?)
            """,
            (story_id, comment.author, comment.content)
        )
        
        comment_id = cursor.lastrowid
        
        # 更新故事的评论计数
        cursor.execute(
            """
            UPDATE stories 
            SET comments_count = comments_count + 1 
            WHERE id = ?
            """,
            (story_id,)
        )
        
        conn.commit()
        
        # 获取刚创建的评论
        cursor.execute("SELECT * FROM comments WHERE id = ?", (comment_id,))
        row = cursor.fetchone()
        conn.close()
        
        return dict_from_row(row)
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"发表评论失败: {str(e)}")
```

---

### 2. 点赞相关接口

#### 2.1 获取故事点赞数

**接口**: `GET /api/stories/{story_id}/likes`

**响应示例**:
```json
{
  "story_id": 5,
  "likes_count": 42,
  "user_liked": false
}
```

**实现代码**:
```python
@app.get("/api/stories/{story_id}/likes")
def get_likes(story_id: int, user_id: str = "anonymous"):
    """获取故事点赞数"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 获取点赞总数
        cursor.execute(
            "SELECT likes_count FROM stories WHERE id = ?",
            (story_id,)
        )
        row = cursor.fetchone()
        if not row:
            conn.close()
            raise HTTPException(status_code=404, detail="故事不存在")
        
        likes_count = row["likes_count"]
        
        # 检查当前用户是否已点赞
        cursor.execute(
            "SELECT id FROM likes WHERE story_id = ? AND user_identifier = ?",
            (story_id, user_id)
        )
        user_liked = cursor.fetchone() is not None
        
        conn.close()
        
        return {
            "story_id": story_id,
            "likes_count": likes_count,
            "user_liked": user_liked
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"获取点赞数失败: {str(e)}")
```

#### 2.2 点赞故事

**接口**: `POST /api/stories/{story_id}/like`

**请求体**:
```json
{
  "user_identifier": "user_123"
}
```

**响应示例**:
```json
{
  "message": "点赞成功",
  "likes_count": 43
}
```

**实现代码**:
```python
class LikeRequest(BaseModel):
    user_identifier: str = "anonymous"

@app.post("/api/stories/{story_id}/like")
def like_story(story_id: int, like_req: LikeRequest):
    """点赞故事"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 检查故事是否存在
        cursor.execute("SELECT id FROM stories WHERE id = ?", (story_id,))
        if not cursor.fetchone():
            conn.close()
            raise HTTPException(status_code=404, detail="故事不存在")
        
        # 检查是否已点赞
        cursor.execute(
            "SELECT id FROM likes WHERE story_id = ? AND user_identifier = ?",
            (story_id, like_req.user_identifier)
        )
        if cursor.fetchone():
            conn.close()
            raise HTTPException(status_code=400, detail="您已经点赞过了")
        
        # 插入点赞记录
        cursor.execute(
            "INSERT INTO likes (story_id, user_identifier) VALUES (?, ?)",
            (story_id, like_req.user_identifier)
        )
        
        # 更新点赞计数
        cursor.execute(
            "UPDATE stories SET likes_count = likes_count + 1 WHERE id = ?",
            (story_id,)
        )
        
        conn.commit()
        
        # 获取最新点赞数
        cursor.execute("SELECT likes_count FROM stories WHERE id = ?", (story_id,))
        likes_count = cursor.fetchone()["likes_count"]
        
        conn.close()
        
        return {
            "message": "点赞成功",
            "likes_count": likes_count
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"点赞失败: {str(e)}")
```

#### 2.3 取消点赞

**接口**: `DELETE /api/stories/{story_id}/like`

**请求体**:
```json
{
  "user_identifier": "user_123"
}
```

**响应示例**:
```json
{
  "message": "已取消点赞",
  "likes_count": 42
}
```

**实现代码**:
```python
@app.delete("/api/stories/{story_id}/like")
def unlike_story(story_id: int, like_req: LikeRequest):
    """取消点赞"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 检查是否已点赞
        cursor.execute(
            "SELECT id FROM likes WHERE story_id = ? AND user_identifier = ?",
            (story_id, like_req.user_identifier)
        )
        if not cursor.fetchone():
            conn.close()
            raise HTTPException(status_code=400, detail="您还没有点赞过")
        
        # 删除点赞记录
        cursor.execute(
            "DELETE FROM likes WHERE story_id = ? AND user_identifier = ?",
            (story_id, like_req.user_identifier)
        )
        
        # 更新点赞计数
        cursor.execute(
            "UPDATE stories SET likes_count = likes_count - 1 WHERE id = ?",
            (story_id,)
        )
        
        conn.commit()
        
        # 获取最新点赞数
        cursor.execute("SELECT likes_count FROM stories WHERE id = ?", (story_id,))
        likes_count = cursor.fetchone()["likes_count"]
        
        conn.close()
        
        return {
            "message": "已取消点赞",
            "likes_count": likes_count
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"取消点赞失败: {str(e)}")
```

---

### 3. 故事列表增强接口

#### 3.1 获取故事列表（支持筛选和排序）

**接口**: `GET /api/stories`

**请求参数**:
- `approved_only` (bool): 仅显示已批准的故事，默认false
- `sort_by` (str): 排序字段 (created_at/likes_count/comments_count)，默认created_at
- `order` (str): 排序方向 (asc/desc)，默认desc
- `limit` (int): 返回数量，默认20
- `offset` (int): 偏移量，默认0
- `category` (str): 故事分类，可选

**响应示例**:
```json
{
  "total": 50,
  "stories": [
    {
      "id": 1,
      "title": "奇幻之旅",
      "author": "张三",
      "content": "很久很久以前...",
      "parent_id": null,
      "is_approved": true,
      "video_url": "/videos/story_1.mp4",
      "video_status": "completed",
      "likes_count": 42,
      "comments_count": 15,
      "views_count": 230,
      "tags": "奇幻,冒险",
      "category": "fantasy",
      "created_at": "2025-10-26T10:00:00"
    }
  ]
}
```

**实现代码**:
```python
@app.get("/api/stories")
def get_stories(
    approved_only: bool = False,
    sort_by: str = "created_at",
    order: str = "desc",
    limit: int = 20,
    offset: int = 0,
    category: Optional[str] = None
):
    """获取故事列表（支持筛选和排序）"""
    try:
        # 验证参数
        valid_sort_fields = ["created_at", "likes_count", "comments_count", "views_count"]
        if sort_by not in valid_sort_fields:
            raise HTTPException(status_code=400, detail=f"无效的排序字段: {sort_by}")
        
        if order not in ["asc", "desc"]:
            raise HTTPException(status_code=400, detail="排序方向必须是 asc 或 desc")
        
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 构建查询条件
        where_clauses = []
        params = []
        
        if approved_only:
            where_clauses.append("is_approved = 1")
        
        if category:
            where_clauses.append("category = ?")
            params.append(category)
        
        where_sql = " WHERE " + " AND ".join(where_clauses) if where_clauses else ""
        
        # 获取总数
        cursor.execute(f"SELECT COUNT(*) as total FROM stories{where_sql}", params)
        total = cursor.fetchone()["total"]
        
        # 获取故事列表
        query = f"""
            SELECT * FROM stories
            {where_sql}
            ORDER BY {sort_by} {order.upper()}
            LIMIT ? OFFSET ?
        """
        cursor.execute(query, params + [limit, offset])
        rows = cursor.fetchall()
        conn.close()
        
        return {
            "total": total,
            "stories": [dict_from_row(row) for row in rows]
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"获取故事列表失败: {str(e)}")
```

---

### 4. 搜索接口

#### 4.1 搜索故事

**接口**: `GET /api/stories/search`

**请求参数**:
- `q` (str): 搜索关键词
- `limit` (int): 返回数量，默认20

**响应示例**:
```json
{
  "total": 5,
  "stories": [...]
}
```

**实现代码**:
```python
@app.get("/api/stories/search")
def search_stories(q: str, limit: int = 20):
    """搜索故事（标题和内容）"""
    try:
        if not q.strip():
            raise HTTPException(status_code=400, detail="搜索关键词不能为空")
        
        conn = get_db_connection()
        cursor = conn.cursor()
        
        search_pattern = f"%{q}%"
        
        cursor.execute(
            """
            SELECT * FROM stories 
            WHERE (title LIKE ? OR content LIKE ?) AND is_approved = 1
            ORDER BY created_at DESC
            LIMIT ?
            """,
            (search_pattern, search_pattern, limit)
        )
        rows = cursor.fetchall()
        conn.close()
        
        return {
            "total": len(rows),
            "stories": [dict_from_row(row) for row in rows]
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"搜索失败: {str(e)}")
```

---

## 🔨 完整实现步骤

### 步骤1: 创建新的数据库迁移函数

在 `backend/main.py` 中添加：

```python
def migrate_db():
    """数据库升级迁移"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    
    try:
        # 检查并添加新字段
        cursor.execute("PRAGMA table_info(stories)")
        columns = [col[1] for col in cursor.fetchall()]
        
        if "likes_count" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN likes_count INTEGER DEFAULT 0")
        if "comments_count" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN comments_count INTEGER DEFAULT 0")
        if "views_count" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN views_count INTEGER DEFAULT 0")
        if "tags" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN tags TEXT DEFAULT ''")
        if "category" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN category TEXT DEFAULT 'general'")
        
        # 创建评论表
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS comments (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                story_id INTEGER NOT NULL,
                author TEXT NOT NULL,
                content TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
            )
        """)
        
        # 创建点赞表
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS likes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                story_id INTEGER NOT NULL,
                user_identifier TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(story_id, user_identifier),
                FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
            )
        """)
        
        # 创建索引
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_stories_approved ON stories(is_approved)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_stories_created_at ON stories(created_at DESC)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_stories_likes ON stories(likes_count DESC)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_comments_story_id ON comments(story_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_likes_story_id ON likes(story_id)")
        
        conn.commit()
        print("✅ 数据库迁移完成")
    except Exception as e:
        print(f"❌ 数据库迁移失败: {e}")
        conn.rollback()
    finally:
        conn.close()

# 在 init_db() 后调用
migrate_db()
```

### 步骤2: 添加所有新的 Pydantic 模型

```python
class CommentCreate(BaseModel):
    author: str
    content: str

class CommentResponse(BaseModel):
    id: int
    story_id: int
    author: str
    content: str
    created_at: str

class LikeRequest(BaseModel):
    user_identifier: str = "anonymous"
```

### 步骤3: 添加所有新接口

将上面的接口实现代码添加到 `main.py` 中。

### 步骤4: 测试接口

使用 curl 或 Postman 测试：

```bash
# 测试发表评论
curl -X POST http://localhost:8000/api/stories/1/comments \
  -H "Content-Type: application/json" \
  -d '{"author":"测试用户","content":"这是一条测试评论"}'

# 测试获取评论
curl http://localhost:8000/api/stories/1/comments

# 测试点赞
curl -X POST http://localhost:8000/api/stories/1/like \
  -H "Content-Type: application/json" \
  -d '{"user_identifier":"user_123"}'

# 测试获取点赞数
curl http://localhost:8000/api/stories/1/likes?user_id=user_123

# 测试搜索
curl "http://localhost:8000/api/stories/search?q=奇幻"
```

---

## 📝 开发规范

### 1. 代码规范
- 所有函数必须有类型注解
- 所有接口必须有错误处理
- 使用 try-except 捕获异常
- 数据库操作后必须关闭连接

### 2. 日志规范
```python
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

logger.info(f"✅ 评论创建成功: comment_id={comment_id}")
logger.error(f"❌ 评论创建失败: {str(e)}")
```

### 3. Git 提交规范
```bash
git commit -m "feat: add comments API endpoints"
git commit -m "feat: add likes functionality"
git commit -m "feat: add story search API"
git commit -m "fix: handle duplicate like error"
```

---

## 🧪 测试清单

- [ ] 所有新接口都能正常响应
- [ ] 错误处理覆盖所有异常情况
- [ ] 数据库迁移成功，无数据丢失
- [ ] 并发请求不会导致数据不一致
- [ ] API 文档已更新（/docs）

---

## 📞 联系方式

**遇到问题请联系**:
- 联调负责人（成员4）
- 前端开发（成员2）需要接口对接

**完成时间**: 第1天下午 16:00 前完成核心接口

