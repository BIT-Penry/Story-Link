# 🎉 新功能测试指南

## 📋 已完成的更新

### 后端更新 ✅
1. ✅ 数据库添加新字段（max_contributors, fork_count, is_original）
2. ✅ 创建故事立即保存，不需要生成视频
3. ✅ 续写限制功能
4. ✅ 新增生成视频接口（仅作者可用）
5. ✅ 新增检查续写权限接口
6. ✅ 修改获取故事列表接口（支持筛选）

### 前端更新 ✅
1. ✅ 昵称设置弹窗（NicknameModal）
2. ✅ 首页显示所有故事
3. ✅ 首页添加筛选功能
4. ✅ 编辑页自动填充昵称
5. ✅ 编辑页添加续写人数设置

---

## 🚀 快速启动

### 1. 启动后端

```bash
cd /Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend

# 激活虚拟环境
source venv/bin/activate

# 启动后端（会自动迁移数据库）
python main.py
```

**预期输出**:
```
✅ 数据库初始化完成
✅ 添加字段: max_contributors
✅ 添加字段: fork_count
✅ 添加字段: is_original
✅ 数据库迁移完成
✅ Mock 视频已存在: videos/mock_video.mp4
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### 2. 启动前端

```bash
# 在新终端
cd /Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/frontend

npm run dev
```

---

## 🧪 测试流程

### 测试 1: 昵称设置

1. **打开首页**: http://localhost:5173/
2. **预期**: 自动弹出昵称设置弹窗
3. **操作**: 输入昵称"测试用户A"，点击"开始创作"
4. **验证**: 
   - 弹窗关闭
   - 右上角显示 "👤 测试用户A"
   - 可以点击昵称修改

---

### 测试 2: 创作原创故事（不生成视频）

1. **点击**: "✨ 写新故事"
2. **填写表单**:
   - 昵称：自动填充为"测试用户A"
   - 标题：奇幻森林的冒险
   - 续写人数：选择"3人"
   - 内容：
     ```
     很久很久以前，在一个被遗忘的森林深处，住着一位神秘的魔法师。
     他拥有一本古老的魔法书，据说能实现任何愿望。
     ```
3. **点击**: "🚀 提交故事"
4. **验证**:
   - ✅ 提示"故事创建成功！"
   - ✅ 自动跳转到故事详情页
   - ✅ 显示故事内容
   - ✅ **不需要生成视频就能看到故事**

---

### 测试 3: 首页显示所有故事

1. **返回首页**
2. **验证**:
   - ✅ 刚创建的故事显示在首页
   - ✅ 有"✨ 原创"标签
   - ✅ 显示"📝 0/3 人续写"
   - ✅ 没有"🎥 有视频"标签

---

### 测试 4: 续写功能（多人续写）

#### 4.1 第一人续写

1. **换一个昵称**: 点击右上角昵称，输入"测试用户B"
2. **进入故事详情页**
3. **点击**: "🍴 Fork 并续写"
4. **填写**:
   - 昵称：自动填充"测试用户B"
   - 标题：自动填充为"奇幻森林的冒险（续）"
   - 内容：
     ```
     年轻的冒险家艾莉听说了这个传说，决定踏入森林寻找魔法师。
     她不知道，这个决定将改变她的一生...
     ```
5. **提交**
6. **验证**:
   - ✅ 续写创建成功
   - ✅ 原故事显示"📝 1/3 人续写"

#### 4.2 第二人续写

1. **换昵称**: 改为"测试用户C"
2. **重复续写流程**
3. **验证**: 原故事显示"📝 2/3 人续写"

#### 4.3 第三人续写

1. **换昵称**: 改为"测试用户D"
2. **续写成功**
3. **验证**: 原故事显示"📝 3/3 人续写"

#### 4.4 第四人尝试续写

1. **换昵称**: 改为"测试用户E"
2. **尝试续写**
3. **预期**: 提示"该故事已达到最大续写人数限制（3人）"

---

### 测试 5: 故事筛选功能

1. **在首页点击筛选按钮**:
   - "📖 全部故事": 显示所有故事（4个：1原创+3续写）
   - "✨ 原创故事": 只显示原创故事（1个）
   - "🔀 续写故事": 只显示续写故事（3个）
   - "🎥 有视频": 无故事（因为还没生成视频）

---

### 测试 6: 生成视频（仅作者可用）

#### 6.1 非作者尝试生成

1. **昵称**: 确保是"测试用户B"（非原故事作者）
2. **进入**: 原创故事详情页
3. **验证**: 看不到"生成视频"按钮

#### 6.2 作者生成视频

1. **切换昵称**: 改为"测试用户A"（原创故事作者）
2. **进入**: 自己的原创故事详情页
3. **应该看到**: "🎬 生成视频"按钮
4. **点击**: "生成视频"
5. **验证**:
   - ✅ 按钮变为"⏳ 视频生成中..."
   - ✅ 后端开始生成视频
   - ✅ 1-5分钟后（或使用Mock视频立即完成）
   - ✅ 按钮变为"🔄 重新生成视频"
   - ✅ 出现视频播放器

#### 6.3 视频生成后

1. **返回首页**
2. **筛选**: 点击"🎥 有视频"
3. **验证**: 能看到刚才的故事
4. **故事卡片**: 有"🎥 有视频"标签

---

## 🔍 API 测试

### 1. 创建故事（不生成视频）

```bash
curl -X POST http://localhost:8000/api/stories \
  -H "Content-Type: application/json" \
  -d '{
    "title": "测试故事",
    "author": "测试用户",
    "content": "这是测试内容...",
    "max_contributors": 3
  }'
```

**预期响应**:
```json
{
  "id": 1,
  "title": "测试故事",
  "author": "测试用户",
  "content": "这是测试内容...",
  "parent_id": null,
  "is_approved": false,
  "video_url": null,
  "video_status": "none",
  "max_contributors": 3,
  "fork_count": 0,
  "is_original": true,
  "created_at": "2025-10-26T10:30:00"
}
```

### 2. 获取所有故事

```bash
curl "http://localhost:8000/api/stories?filter_by=all&limit=50"
```

### 3. 检查续写权限

```bash
curl http://localhost:8000/api/stories/1/can-fork
```

**预期响应**:
```json
{
  "can_fork": true,
  "max_contributors": 3,
  "current_forks": 0,
  "remaining": 3,
  "title": "测试故事",
  "author": "测试用户"
}
```

### 4. 生成视频（仅作者）

```bash
curl -X POST http://localhost:8000/api/stories/1/generate-video \
  -H "Content-Type: application/json" \
  -d '{
    "author": "测试用户"
  }'
```

**预期响应**:
```json
{
  "message": "视频生成任务已启动",
  "story_id": 1,
  "status": "generating"
}
```

### 5. 非作者尝试生成视频

```bash
curl -X POST http://localhost:8000/api/stories/1/generate-video \
  -H "Content-Type: application/json" \
  -d '{
    "author": "其他用户"
  }'
```

**预期响应** (403 Forbidden):
```json
{
  "detail": "只有故事作者可以生成视频"
}
```

---

## ✅ 功能检查清单

### 昵称系统
- [ ] 首次访问弹出昵称设置
- [ ] 昵称保存到 localStorage
- [ ] 右上角显示当前昵称
- [ ] 可以点击修改昵称
- [ ] 编辑页自动填充昵称

### 故事创建
- [ ] 可以立即创建故事（不需要生成视频）
- [ ] 可以设置续写人数（1-5人）
- [ ] 创建成功后跳转到详情页
- [ ] 故事立即显示在首页

### 续写功能
- [ ] 可以 Fork 其他人的故事
- [ ] 续写计数正确更新
- [ ] 达到限制后无法续写
- [ ] 错误提示清晰

### 首页展示
- [ ] 显示所有故事（包括未生成视频的）
- [ ] 筛选功能正常工作
- [ ] 标签显示正确（原创/续写/有视频）
- [ ] 续写计数显示正确

### 视频生成
- [ ] 只有作者能看到生成视频按钮
- [ ] 非作者无法生成视频
- [ ] 生成状态正确显示
- [ ] 视频生成后可以播放

---

## 🐛 常见问题

### 问题 1: 数据库迁移失败

**解决方案**:
```bash
cd backend
rm storylink.db
python main.py  # 重新创建数据库
```

### 问题 2: 昵称弹窗一直出现

**解决方案**:
```javascript
// 打开浏览器控制台
localStorage.setItem('user_nickname', '你的昵称')
location.reload()
```

### 问题 3: 前端无法获取故事

**检查**:
1. 后端是否运行在 8000 端口
2. 浏览器控制台是否有错误
3. Network 标签查看 API 请求状态

---

## 📊 性能测试

### 创建100个故事

```bash
for i in {1..100}; do
  curl -X POST http://localhost:8000/api/stories \
    -H "Content-Type: application/json" \
    -d "{
      \"title\": \"故事$i\",
      \"author\": \"用户$i\",
      \"content\": \"这是第$i个测试故事\",
      \"max_contributors\": 5
    }" &
done
wait
```

### 查看结果

```bash
curl "http://localhost:8000/api/stories?limit=100" | jq '. | length'
```

---

## 🎯 下一步改进

1. **故事详情页**: 添加生成视频按钮的 UI
2. **续写提示**: Fork 时显示还能续写几次
3. **视频轮询**: 自动刷新视频生成状态
4. **优化体验**: 添加更多加载动画和过渡效果

---

**测试愉快！🚀**

有问题请查看后端日志或前端控制台。

