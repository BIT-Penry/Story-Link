# 🔗 联调测试文档 - 成员4

**开发者**: 联调 & 演示负责人  
**分支名称**: `feat/integration-<你的名字>`  
**开发周期**: 1-2天  
**核心职责**: 系统集成、全流程测试、演示准备、项目协调

---

## 📋 任务清单

### 优先级 P0 (必须完成)

- [ ] 确保所有成员环境配置正常
- [ ] 执行完整的端到端测试
- [ ] 编写演示脚本
- [ ] 准备演示数据
- [ ] 录制备用演示视频
- [ ] 组织每日集成检查（12:00 & 16:00）

### 优先级 P1 (强烈建议)

- [ ] 配置 ngrok 公网访问
- [ ] 更新所有文档
- [ ] 准备技术答辩 Q&A
- [ ] 优化启动脚本
- [ ] 编写故障排除指南

### 优先级 P2 (时间充裕时)

- [ ] 性能测试
- [ ] 压力测试
- [ ] 准备 PPT
- [ ] 录制功能演示视频

---

## 🔧 环境配置检查清单

### 1. 后端环境检查

```bash
# 进入后端目录
cd backend

# 检查 Python 版本
python --version  # 应该是 3.9+

# 检查依赖安装
pip list | grep -E "fastapi|openai|google"

# 检查环境变量
cat ../.env  # 确保 API Key 已配置

# 启动后端
python main.py
```

**预期输出**:
```
✅ 数据库初始化完成
✅ 数据库迁移完成
✅ Mock 视频已存在: videos/mock_video.mp4
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### 2. 前端环境检查

```bash
# 进入前端目录
cd frontend

# 检查 Node.js 版本
node --version  # 应该是 18+

# 检查依赖安装
npm list --depth=0

# 启动前端
npm run dev
```

**预期输出**:
```
VITE v5.x.x  ready in xxx ms

➜  Local:   http://localhost:5173/
➜  Network: use --host to expose
```

### 3. API 连通性测试

```bash
# 测试后端健康检查
curl http://localhost:8000/

# 测试 API 文档
open http://localhost:8000/docs

# 测试获取故事列表
curl http://localhost:8000/api/stories
```

---

## 🧪 完整测试用例

### 测试流程 1: 创作新故事

#### 步骤 1.1: 创建原始故事

**操作**:
1. 打开 http://localhost:5173/
2. 点击"✨ 写新故事"
3. 填写表单:
   - 昵称: 测试用户A
   - 标题: 奇幻森林的冒险
   - 内容: 很久很久以前，有一个充满魔法的森林...

4. 点击"提交"

**预期结果**:
- ✅ 故事创建成功
- ✅ 自动跳转到故事详情页
- ✅ 显示故事内容

#### 步骤 1.2: AI 润色

**操作**:
1. 在故事详情页点击"🤖 AI 润色"
2. 选择润色风格（如果已实现多风格）
3. 等待润色完成

**预期结果**:
- ✅ 显示 loading 动画
- ✅ 3-10 秒内返回结果
- ✅ 内容被优化（更生动、流畅）

#### 步骤 1.3: Fork 并续写

**操作**:
1. 点击"🍴 Fork 并续写"
2. 修改续写内容
3. 提交

**预期结果**:
- ✅ 跳转到编辑页
- ✅ 标题自动填充为"原标题（续）"
- ✅ 新故事的 parent_id 指向原故事

#### 步骤 1.4: 发布为视频

**操作**:
1. 在故事详情页点击"🚀 发布为视频"
2. 确认操作

**预期结果**:
- ✅ 显示"视频生成中"状态
- ✅ video_status 变为 "generating"
- ✅ 1-5 分钟后（或立即如果使用 Mock）完成
- ✅ 可以播放视频

### 测试流程 2: 评论和点赞

#### 步骤 2.1: 发表评论

**操作**:
1. 在故事详情页找到评论区
2. 填写昵称和评论内容
3. 提交

**预期结果**:
- ✅ 评论立即显示
- ✅ 评论计数 +1
- ✅ 表单清空

#### 步骤 2.2: 点赞

**操作**:
1. 点击点赞按钮

**预期结果**:
- ✅ 按钮变为已点赞状态
- ✅ 点赞数 +1
- ✅ 再次点击取消点赞

### 测试流程 3: 首页功能

#### 步骤 3.1: 筛选和排序

**操作**:
1. 访问首页
2. 切换排序方式（最新/最热/最多评论）
3. 切换"仅显示已发布"

**预期结果**:
- ✅ 故事列表按选择的方式重新排序
- ✅ 筛选条件生效

#### 步骤 3.2: 搜索

**操作**:
1. 在搜索框输入关键词
2. 点击搜索

**预期结果**:
- ✅ 返回包含关键词的故事
- ✅ 高亮显示关键词（如果实现）

---

## 📊 测试矩阵

| 功能模块 | 测试项 | 负责人 | 状态 |
|---------|--------|--------|------|
| 后端-故事 | 创建/获取/列表 | 成员1 | ⬜️ |
| 后端-评论 | 发表/获取评论 | 成员1 | ⬜️ |
| 后端-点赞 | 点赞/取消点赞 | 成员1 | ⬜️ |
| 后端-AI | 文本润色 | 成员3 | ⬜️ |
| 后端-AI | 视频生成 | 成员3 | ⬜️ |
| 前端-首页 | 列表/筛选/排序 | 成员2 | ⬜️ |
| 前端-详情页 | 显示/操作 | 成员2 | ⬜️ |
| 前端-编辑页 | 创建/Fork | 成员2 | ⬜️ |
| 前端-评论 | 评论组件 | 成员2 | ⬜️ |
| 前端-点赞 | 点赞组件 | 成员2 | ⬜️ |
| 集成测试 | 端到端流程 | 成员4 | ⬜️ |

---

## 🎬 演示脚本

### 演示时长: 2分钟

#### 开场白 (10秒)

> "大家好！我们是 StoryLink 团队。StoryLink 是一个 AI 驱动的故事创作平台，让每个人都能轻松创作和分享精彩故事，并自动生成视频。"

#### 演示流程 (100秒)

**1. 创作故事 (30秒)**

操作:
- 点击"写新故事"
- 快速填写（使用预先准备的内容）
- 提交

解说:
> "首先，用户可以快速创作一个故事。只需填写标题、昵称和内容，就能发布自己的创意。"

**2. AI 润色 (20秒)**

操作:
- 进入故事详情
- 点击"AI 润色"
- 展示润色结果

解说:
> "我们的 AI 助手可以自动优化故事的表达，让它更生动、更有感染力。"

**3. Fork 续写 (20秒)**

操作:
- 点击"Fork 并续写"
- 修改内容
- 提交

解说:
> "任何人都可以 Fork 其他人的故事，添加自己的续集。这就像 GitHub，但是用来创作故事。"

**4. 视频生成 (20秒)**

操作:
- 点击"发布为视频"
- 展示生成进度
- 播放视频

解说:
> "最激动人心的是，我们可以将故事自动转换为短视频。系统会调用 Google Veo AI，生成高质量的影视内容。"

**5. 社交互动 (10秒)**

操作:
- 展示评论
- 展示点赞

解说:
> "用户还可以评论和点赞喜欢的故事，形成创作社区。"

#### 结束语 (10秒)

> "StoryLink 让创作变得简单、有趣、协作化。AI 不仅是工具，更是每个人的创意伙伴。谢谢大家！"

### 演示数据准备

在演示前创建以下测试数据：

**故事1: 已完成的故事（带视频）**
```json
{
  "title": "月光下的约定",
  "author": "创作者A",
  "content": "在一个宁静的夏夜，月光如水般洒落在古老的小镇上。李明站在桥头，等待着十年前的约定...",
  "is_approved": true,
  "video_url": "/videos/demo_video_1.mp4"
}
```

**故事2: 续写链**
```
原故事 → Fork1 → Fork2
```

**故事3: 高点赞故事**
```json
{
  "likes_count": 42,
  "comments_count": 15
}
```

---

## 🌐 公网访问配置

### 使用 ngrok

#### 1. 安装 ngrok

```bash
# macOS
brew install ngrok

# 或下载
# https://ngrok.com/download
```

#### 2. 启动后端隧道

```bash
# 在新终端运行
ngrok http 8000
```

记录公网 URL，例如: `https://abc123.ngrok.io`

#### 3. 启动前端隧道

```bash
# 在新终端运行
ngrok http 5173
```

记录公网 URL，例如: `https://def456.ngrok.io`

#### 4. 更新前端配置

在 `frontend/vite.config.js` 或 `.env` 中更新后端 URL：

```javascript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'https://abc123.ngrok.io',  // 你的后端 ngrok URL
        changeOrigin: true,
      }
    }
  }
})
```

---

## 📝 每日集成检查流程

### 12:00 中午检查

#### 检查项:

1. **代码同步**
   ```bash
   git fetch origin main
   git log HEAD..origin/main --oneline
   ```

2. **功能进度**
   - 成员1: 后端 API 完成度？
   - 成员2: 前端页面完成度？
   - 成员3: AI 功能完成度？

3. **快速集成测试**
   ```bash
   # 拉取最新 main 分支
   git checkout main
   git pull
   
   # 启动服务
   ./start.sh
   
   # 测试核心流程
   # 1. 创建故事
   # 2. 查看列表
   # 3. 测试 AI 功能
   ```

4. **问题记录**
   - 发现的 Bug
   - 需要协调的问题
   - 阻塞项

### 16:00 下午检查

#### 检查项:

1. **PR 审核**
   - 查看待合并的 PR
   - 快速 code review
   - 合并通过的 PR

2. **完整测试**
   - 执行完整测试用例
   - 记录测试结果
   - 更新测试矩阵

3. **当日总结**
   - 今日完成的功能
   - 明日计划
   - 风险提示

---

## 🐛 故障排除指南

### 问题 1: 后端无法启动

**现象**: `python main.py` 报错

**排查步骤**:
```bash
# 1. 检查端口占用
lsof -i :8000

# 2. 检查依赖
pip install -r backend/requirements.txt

# 3. 检查数据库
ls -la backend/storylink.db

# 4. 查看详细错误
python backend/main.py 2>&1 | tee backend.log
```

### 问题 2: 前端无法访问后端

**现象**: 网络请求失败

**排查步骤**:
```bash
# 1. 检查后端是否运行
curl http://localhost:8000/

# 2. 检查 CORS 配置
# 在 backend/main.py 中确认 allow_origins

# 3. 检查前端代理配置
# 查看 frontend/vite.config.js

# 4. 查看浏览器控制台错误
# F12 -> Console / Network
```

### 问题 3: 视频生成失败

**现象**: 视频状态一直是 "generating" 或 "failed"

**排查步骤**:
```bash
# 1. 检查 API Key
echo $GOOGLE_API_KEY

# 2. 查看后端日志
# 应该有详细的错误信息

# 3. 测试 Mock 视频
ls -la backend/videos/mock_video.mp4

# 4. 手动测试 AI 服务
python -c "from backend.ai_service import generate_video; print(generate_video('test', 999))"
```

### 问题 4: 数据库问题

**现象**: 数据丢失或表结构错误

**排查步骤**:
```bash
# 1. 备份当前数据库
cp backend/storylink.db backend/storylink.db.backup

# 2. 查看表结构
sqlite3 backend/storylink.db ".schema"

# 3. 重建数据库（警告：会丢失数据）
rm backend/storylink.db
python backend/main.py

# 4. 或手动迁移
sqlite3 backend/storylink.db
> ALTER TABLE stories ADD COLUMN likes_count INTEGER DEFAULT 0;
```

---

## 📹 录制备用演示视频

### 录制工具

- **macOS**: QuickTime Player (Cmd+Shift+5)
- **Windows**: Xbox Game Bar (Win+G)
- **跨平台**: OBS Studio

### 录制清单

1. **完整流程演示** (2分钟)
   - 按演示脚本录制
   - 确保无卡顿
   - 添加解说（可后期配音）

2. **功能特性展示** (各30秒)
   - AI 润色功能
   - Fork 续写功能
   - 视频生成功能
   - 评论点赞功能

### 后期处理

```bash
# 使用 ffmpeg 压缩视频
ffmpeg -i demo.mov -c:v libx264 -crf 23 -preset medium demo_compressed.mp4

# 添加字幕
ffmpeg -i demo.mp4 -vf "subtitles=subtitles.srt" demo_with_subs.mp4
```

---

## 📊 性能测试（可选）

### 简单压力测试

```bash
# 安装 Apache Bench
brew install httpd  # macOS

# 测试故事列表接口
ab -n 100 -c 10 http://localhost:8000/api/stories

# 测试创建故事接口
ab -n 50 -c 5 -p story.json -T application/json http://localhost:8000/api/stories
```

**story.json**:
```json
{
  "title": "性能测试故事",
  "author": "测试用户",
  "content": "这是一个性能测试..."
}
```

---

## 📚 文档更新检查

- [ ] README.md - 启动指南是否准确？
- [ ] API 文档 - 所有新接口都已文档化？
- [ ] BUGFIX.md - 已修复的 Bug 是否标记？
- [ ] 产品MVP.md - 功能完成度是否更新？

---

## 🎯 演示前最终检查（T-1小时）

### 1. 代码冻结
```bash
# 停止所有开发工作
# 拉取最新代码
git checkout main
git pull origin main

# 创建演示分支（只用于演示）
git checkout -b demo-freeze
```

### 2. 环境清理
```bash
# 清空数据库
rm backend/storylink.db

# 重新初始化
python backend/main.py &

# 创建演示数据
python scripts/create_demo_data.py  # 如果有的话
```

### 3. 完整演练
- 按演示脚本完整走一遍
- 计时确保在 2 分钟内
- 记录任何问题

### 4. 备份方案
- 确认备用视频可播放
- 准备离线演示（如果网络不稳定）
- 准备纸质演示稿

---

## 📞 紧急联系

### 演示当天紧急处理流程

1. **服务崩溃** → 立即播放备用视频
2. **网络故障** → 切换到本地演示
3. **功能异常** → 跳过该功能，讲解设计思路

### 团队协调

- **组长**: 负责演讲和时间控制
- **成员1**: 负责后端监控
- **成员2**: 负责操作演示
- **成员3**: 负责技术答疑
- **成员4**: 负责应急处理

---

## ✅ 最终交付清单

- [ ] 系统可正常运行
- [ ] 核心功能全部可用
- [ ] 演示脚本已熟练
- [ ] 备用视频已准备
- [ ] 文档已更新完整
- [ ] 代码已提交到 main 分支
- [ ] 演示数据已准备
- [ ] 团队成员已分工明确

---

**祝演示成功！🎉**

