# 📋 StoryLink 需求变更实现方案

## 🎯 新需求总结

### 核心变更

1. **昵称系统**：用户进入网站时需要设置昵称（存储在 localStorage）
2. **故事即时保存**：创建故事后立即保存，不需要生成视频
3. **续写限制**：作者可以设置允许多少人续写（1-5人）
4. **首页展示**：显示所有故事（包括未生成视频的）
5. **视频生成权限**：只有故事作者可以选择是否生成视频
6. **视频状态独立**：生成视频是可选操作，不影响故事展示

---

## 🗄️ 数据库结构变更

### 修改 stories 表

```sql
-- 添加新字段
ALTER TABLE stories ADD COLUMN max_contributors INTEGER DEFAULT 5;
ALTER TABLE stories ADD COLUMN fork_count INTEGER DEFAULT 0;
ALTER TABLE stories ADD COLUMN is_original BOOLEAN DEFAULT TRUE;

-- 字段说明：
-- max_contributors: 允许的最大续写人数（1-5）
-- fork_count: 当前已有多少人续写
-- is_original: 是否是原创故事（TRUE）还是续写（FALSE）
```

### 完整表结构

```sql
CREATE TABLE IF NOT EXISTS stories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    author TEXT NOT NULL,
    content TEXT NOT NULL,
    parent_id INTEGER,
    is_approved BOOLEAN DEFAULT FALSE,
    video_url TEXT,
    video_status TEXT DEFAULT 'none',  -- 改为 'none' 表示未生成
    max_contributors INTEGER DEFAULT 5,
    fork_count INTEGER DEFAULT 0,
    is_original BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES stories(id)
);
```

---

## 🔧 后端实现

### 1. 更新数据库初始化

修改 `backend/main.py`:

```python
def init_db():
    """创建数据库表"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS stories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL,
            author TEXT NOT NULL,
            content TEXT NOT NULL,
            parent_id INTEGER,
            is_approved BOOLEAN DEFAULT FALSE,
            video_url TEXT,
            video_status TEXT DEFAULT 'none',
            max_contributors INTEGER DEFAULT 5,
            fork_count INTEGER DEFAULT 0,
            is_original BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (parent_id) REFERENCES stories(id)
        )
    """)
    
    conn.commit()
    conn.close()
    print("✅ 数据库初始化完成")

def migrate_db():
    """迁移现有数据库"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    
    try:
        # 检查字段是否存在
        cursor.execute("PRAGMA table_info(stories)")
        columns = [col[1] for col in cursor.fetchall()]
        
        # 添加新字段
        if "max_contributors" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN max_contributors INTEGER DEFAULT 5")
        if "fork_count" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN fork_count INTEGER DEFAULT 0")
        if "is_original" not in columns:
            cursor.execute("ALTER TABLE stories ADD COLUMN is_original BOOLEAN DEFAULT TRUE")
        
        # 更新现有数据的 video_status
        cursor.execute("UPDATE stories SET video_status = 'none' WHERE video_status = 'pending'")
        
        conn.commit()
        print("✅ 数据库迁移完成")
    except Exception as e:
        print(f"⚠️ 数据库迁移失败: {e}")
        conn.rollback()
    finally:
        conn.close()

# 在 init_db() 后调用
init_db()
migrate_db()
```

### 2. 更新 Pydantic 模型

```python
class StoryCreate(BaseModel):
    title: str
    author: str
    content: str
    parent_id: Optional[int] = None
    max_contributors: int = 5  # 新增：允许的续写人数

class StoryResponse(BaseModel):
    id: int
    title: str
    author: str
    content: str
    parent_id: Optional[int]
    is_approved: bool
    video_url: Optional[str]
    video_status: str
    max_contributors: int  # 新增
    fork_count: int  # 新增
    is_original: bool  # 新增
    created_at: str
```

### 3. 修改创建故事接口

```python
@app.post("/api/stories", response_model=StoryResponse)
def create_story(story: StoryCreate):
    """创建新故事（立即保存，不需要生成视频）"""
    try:
        # 验证参数
        if not story.title.strip():
            raise HTTPException(status_code=400, detail="标题不能为空")
        if not story.author.strip():
            raise HTTPException(status_code=400, detail="作者昵称不能为空")
        if not story.content.strip():
            raise HTTPException(status_code=400, detail="内容不能为空")
        if story.max_contributors < 1 or story.max_contributors > 5:
            raise HTTPException(status_code=400, detail="续写人数必须在1-5之间")
        
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 如果是续写（有 parent_id）
        is_original = story.parent_id is None
        
        if not is_original:
            # 检查父故事是否存在
            cursor.execute("SELECT max_contributors, fork_count FROM stories WHERE id = ?", 
                         (story.parent_id,))
            parent = cursor.fetchone()
            
            if not parent:
                conn.close()
                raise HTTPException(status_code=404, detail="父故事不存在")
            
            # 检查是否超过续写人数限制
            if parent["fork_count"] >= parent["max_contributors"]:
                conn.close()
                raise HTTPException(
                    status_code=400, 
                    detail=f"该故事已达到最大续写人数限制（{parent['max_contributors']}人）"
                )
            
            # 更新父故事的续写计数
            cursor.execute(
                "UPDATE stories SET fork_count = fork_count + 1 WHERE id = ?",
                (story.parent_id,)
            )
        
        # 插入新故事
        cursor.execute(
            """
            INSERT INTO stories 
            (title, author, content, parent_id, max_contributors, is_original, video_status)
            VALUES (?, ?, ?, ?, ?, ?, 'none')
            """,
            (story.title, story.author, story.content, story.parent_id, 
             story.max_contributors, is_original)
        )
        
        conn.commit()
        story_id = cursor.lastrowid
        
        # 获取刚创建的故事
        cursor.execute("SELECT * FROM stories WHERE id = ?", (story_id,))
        row = cursor.fetchone()
        conn.close()
        
        print(f"✅ 故事创建成功: id={story_id}, author={story.author}, is_original={is_original}")
        
        return dict_from_row(row)
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"创建故事失败: {str(e)}")
```

### 4. 修改获取故事列表接口

```python
@app.get("/api/stories", response_model=List[StoryResponse])
def get_stories(
    filter_by: str = "all",  # all, original, fork, with_video
    sort_by: str = "created_at",  # created_at, fork_count
    limit: int = 50
):
    """
    获取故事列表
    
    filter_by:
        - all: 所有故事
        - original: 仅原创故事
        - fork: 仅续写故事
        - with_video: 有视频的故事
    """
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 构建查询条件
        where_clause = ""
        if filter_by == "original":
            where_clause = "WHERE is_original = 1"
        elif filter_by == "fork":
            where_clause = "WHERE is_original = 0"
        elif filter_by == "with_video":
            where_clause = "WHERE video_status = 'completed'"
        
        # 验证排序字段
        if sort_by not in ["created_at", "fork_count"]:
            sort_by = "created_at"
        
        query = f"""
            SELECT * FROM stories 
            {where_clause}
            ORDER BY {sort_by} DESC 
            LIMIT ?
        """
        
        cursor.execute(query, (limit,))
        rows = cursor.fetchall()
        conn.close()
        
        return [dict_from_row(row) for row in rows]
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"获取故事列表失败: {str(e)}")
```

### 5. 添加生成视频接口（仅作者可用）

```python
class GenerateVideoRequest(BaseModel):
    author: str  # 验证作者身份

@app.post("/api/stories/{story_id}/generate-video")
def generate_video_for_story(
    story_id: int, 
    request: GenerateVideoRequest,
    background_tasks: BackgroundTasks
):
    """
    为故事生成视频（仅作者可操作）
    """
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 获取故事信息
        cursor.execute("SELECT * FROM stories WHERE id = ?", (story_id,))
        story = cursor.fetchone()
        
        if not story:
            conn.close()
            raise HTTPException(status_code=404, detail="故事不存在")
        
        # 验证作者身份
        if story["author"] != request.author:
            conn.close()
            raise HTTPException(status_code=403, detail="只有故事作者可以生成视频")
        
        # 检查是否已经在生成中
        if story["video_status"] == "generating":
            conn.close()
            raise HTTPException(status_code=400, detail="视频正在生成中，请稍候")
        
        # 更新状态为生成中
        cursor.execute(
            "UPDATE stories SET video_status = 'generating' WHERE id = ?",
            (story_id,)
        )
        conn.commit()
        conn.close()
        
        # 后台任务：生成视频
        background_tasks.add_task(generate_video_task, story_id, story["content"])
        
        return {
            "message": "视频生成任务已启动",
            "story_id": story_id,
            "status": "generating"
        }
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"生成视频失败: {str(e)}")
```

### 6. 添加检查续写权限接口

```python
@app.get("/api/stories/{story_id}/can-fork")
def check_can_fork(story_id: int):
    """检查故事是否还能被续写"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute(
            "SELECT max_contributors, fork_count FROM stories WHERE id = ?",
            (story_id,)
        )
        row = cursor.fetchone()
        conn.close()
        
        if not row:
            raise HTTPException(status_code=404, detail="故事不存在")
        
        can_fork = row["fork_count"] < row["max_contributors"]
        
        return {
            "can_fork": can_fork,
            "max_contributors": row["max_contributors"],
            "current_forks": row["fork_count"],
            "remaining": row["max_contributors"] - row["fork_count"]
        }
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"检查失败: {str(e)}")
```

---

## 🎨 前端实现

### 1. 创建昵称设置组件

创建 `frontend/src/components/NicknameModal.jsx`:

```jsx
import { useState, useEffect } from 'react'

export default function NicknameModal({ onComplete }) {
  const [nickname, setNickname] = useState('')
  const [show, setShow] = useState(false)

  useEffect(() => {
    // 检查是否已设置昵称
    const savedNickname = localStorage.getItem('user_nickname')
    if (!savedNickname) {
      setShow(true)
    } else {
      onComplete(savedNickname)
    }
  }, [])

  const handleSubmit = (e) => {
    e.preventDefault()
    
    if (!nickname.trim()) {
      alert('请输入昵称')
      return
    }
    
    if (nickname.length > 20) {
      alert('昵称不能超过20个字符')
      return
    }
    
    // 保存昵称到 localStorage
    localStorage.setItem('user_nickname', nickname.trim())
    setShow(false)
    onComplete(nickname.trim())
  }

  const handleChangeNickname = () => {
    const newNickname = prompt('请输入新昵称:', nickname)
    if (newNickname && newNickname.trim()) {
      setNickname(newNickname.trim())
      localStorage.setItem('user_nickname', newNickname.trim())
    }
  }

  if (!show) return null

  return (
    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
        <h2 className="text-3xl font-bold text-gray-800 mb-4 text-center">
          👋 欢迎来到 StoryLink
        </h2>
        
        <p className="text-gray-600 mb-6 text-center">
          请设置您的昵称以开始创作
        </p>
        
        <form onSubmit={handleSubmit}>
          <input
            type="text"
            value={nickname}
            onChange={(e) => setNickname(e.target.value)}
            placeholder="输入您的昵称"
            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-lg mb-4"
            maxLength={20}
            autoFocus
          />
          
          <button
            type="submit"
            className="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-bold text-lg hover:shadow-lg transition-all"
          >
            开始创作
          </button>
        </form>
        
        <p className="text-sm text-gray-500 mt-4 text-center">
          昵称会保存在本地，您随时可以更改
        </p>
      </div>
    </div>
  )
}
```

### 2. 更新首页

修改 `frontend/src/pages/HomePage.jsx`:

```jsx
import { useState, useEffect } from 'react'
import { Link } from 'react-router-dom'
import { getAllStories } from '../api/api'  // 改用获取所有故事
import NicknameModal from '../components/NicknameModal'

function HomePage() {
  const [stories, setStories] = useState([])
  const [loading, setLoading] = useState(true)
  const [userNickname, setUserNickname] = useState('')
  const [filterBy, setFilterBy] = useState('all')  // all, original, fork, with_video

  useEffect(() => {
    const nickname = localStorage.getItem('user_nickname')
    if (nickname) {
      setUserNickname(nickname)
      loadStories()
    }
  }, [filterBy])

  const loadStories = async () => {
    try {
      setLoading(true)
      const response = await fetch(`/api/stories?filter_by=${filterBy}&limit=50`)
      const data = await response.json()
      setStories(data)
    } catch (err) {
      console.error('加载故事失败:', err)
    } finally {
      setLoading(false)
    }
  }

  const handleNicknameComplete = (nickname) => {
    setUserNickname(nickname)
    loadStories()
  }

  const changeNickname = () => {
    const newNickname = prompt('请输入新昵称:', userNickname)
    if (newNickname && newNickname.trim()) {
      localStorage.setItem('user_nickname', newNickname.trim())
      setUserNickname(newNickname.trim())
    }
  }

  return (
    <div className="min-h-screen py-8 px-4">
      {/* 昵称设置弹窗 */}
      <NicknameModal onComplete={handleNicknameComplete} />

      <div className="max-w-6xl mx-auto">
        {/* 头部 */}
        <header className="text-center mb-12">
          <div className="flex justify-between items-center mb-4">
            <div className="flex-1"></div>
            <h1 className="text-6xl font-bold text-white flex-1">
              🎬 StoryLink
            </h1>
            <div className="flex-1 text-right">
              {userNickname && (
                <button
                  onClick={changeNickname}
                  className="text-white/80 hover:text-white text-sm underline"
                >
                  👤 {userNickname}
                </button>
              )}
            </div>
          </div>
          
          <p className="text-xl text-white/80 mb-8">
            欢迎来到影视创作版 Github，携手共创下一个经典
          </p>
          
          <Link
            to="/edit"
            className="inline-flex items-center px-8 py-4 bg-white text-purple-600 rounded-full font-bold text-lg hover:bg-purple-50 transition-all transform hover:scale-105 shadow-lg"
          >
            <span className="text-2xl mr-2">✨</span>
            写新故事
          </Link>
        </header>

        {/* 筛选栏 */}
        <div className="flex gap-4 mb-6 justify-center flex-wrap">
          {[
            { value: 'all', label: '全部故事' },
            { value: 'original', label: '原创故事' },
            { value: 'fork', label: '续写故事' },
            { value: 'with_video', label: '有视频的故事' }
          ].map(filter => (
            <button
              key={filter.value}
              onClick={() => setFilterBy(filter.value)}
              className={`px-6 py-2 rounded-full font-medium transition-all ${
                filterBy === filter.value
                  ? 'bg-white text-purple-600'
                  : 'bg-white/20 text-white hover:bg-white/30'
              }`}
            >
              {filter.label}
            </button>
          ))}
        </div>

        {/* 故事列表 */}
        <div className="space-y-6">
          {loading && (
            <div className="text-center py-12">
              <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent"></div>
              <p className="text-white mt-4">加载中...</p>
            </div>
          )}

          {!loading && stories.length === 0 && (
            <div className="bg-white/10 backdrop-blur-md rounded-2xl p-12 text-center text-white">
              <p className="text-xl mb-4">还没有故事</p>
              <p className="text-white/60">成为第一个创作者吧!</p>
            </div>
          )}

          {!loading && stories.length > 0 && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {stories.map((story) => (
                <div
                  key={story.id}
                  className="bg-white/10 backdrop-blur-md rounded-2xl p-6 hover:bg-white/20 transition-all transform hover:scale-105 border border-white/20"
                >
                  {/* 标签 */}
                  <div className="flex gap-2 mb-3">
                    {story.is_original ? (
                      <span className="px-2 py-1 bg-blue-500/80 text-white text-xs rounded-full">
                        原创
                      </span>
                    ) : (
                      <span className="px-2 py-1 bg-green-500/80 text-white text-xs rounded-full">
                        续写
                      </span>
                    )}
                    
                    {story.video_status === 'completed' && (
                      <span className="px-2 py-1 bg-pink-500/80 text-white text-xs rounded-full">
                        🎥 有视频
                      </span>
                    )}
                  </div>

                  <h3 className="text-xl font-bold text-white mb-2 line-clamp-2">
                    {story.title}
                  </h3>
                  
                  <p className="text-white/60 text-sm mb-2">
                    👤 {story.author}
                  </p>

                  {story.is_original && (
                    <p className="text-white/60 text-xs mb-4">
                      🔀 {story.fork_count}/{story.max_contributors} 人续写
                    </p>
                  )}

                  <p className="text-white/80 text-sm mb-4 line-clamp-3">
                    {story.content}
                  </p>

                  <div className="flex gap-2">
                    <Link
                      to={`/story/${story.id}`}
                      className="flex-1 text-center px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors font-medium"
                    >
                      查看详情
                    </Link>
                    
                    {story.video_status === 'completed' && story.video_url && (
                      <Link
                        to={`/story/${story.id}`}
                        className="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors font-medium"
                      >
                        ▶️
                      </Link>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

export default HomePage
```

### 3. 更新编辑页

修改 `frontend/src/pages/EditPage.jsx`，添加续写人数设置：

```jsx
// 在表单中添加续写人数选择
<div className="mb-6">
  <label className="block text-white text-sm font-bold mb-2">
    允许多少人续写？（1-5人）
  </label>
  <select
    value={maxContributors}
    onChange={(e) => setMaxContributors(Number(e.target.value))}
    className="w-full px-4 py-3 bg-white/90 border-2 border-white rounded-lg focus:outline-none focus:border-purple-400"
  >
    {[1, 2, 3, 4, 5].map(num => (
      <option key={num} value={num}>{num} 人</option>
    ))}
  </select>
</div>
```

### 4. 更新故事详情页

添加生成视频按钮（仅作者可见）：

```jsx
// 在详情页添加
{story.author === userNickname && (
  <div className="mb-6">
    {story.video_status === 'none' && (
      <button
        onClick={handleGenerateVideo}
        className="px-6 py-3 bg-gradient-to-r from-pink-500 to-red-500 text-white rounded-lg font-bold hover:shadow-lg transition-all"
      >
        🎬 生成视频
      </button>
    )}
    
    {story.video_status === 'generating' && (
      <div className="px-6 py-3 bg-yellow-500/50 text-white rounded-lg font-bold">
        ⏳ 视频生成中...
      </div>
    )}
    
    {story.video_status === 'completed' && (
      <button
        onClick={handleRegenerateVideo}
        className="px-6 py-3 bg-purple-500 text-white rounded-lg font-bold hover:bg-purple-600 transition-all"
      >
        🔄 重新生成视频
      </button>
    )}
  </div>
)}
```

---

## 📝 实施步骤

### 步骤 1: 备份数据库

```bash
cd /Applications/宋晗搏/黑客松/中关村_22组_hub/Story-Link/backend
cp storylink.db storylink.db.backup
```

### 步骤 2: 更新后端

```bash
# 1. 修改 backend/main.py（参考上面的代码）
# 2. 重启后端服务
python main.py
```

### 步骤 3: 更新前端

```bash
# 1. 创建 NicknameModal 组件
# 2. 修改 HomePage.jsx
# 3. 修改 EditPage.jsx
# 4. 修改 StoryDetailPage.jsx
# 5. 重启前端
npm run dev
```

### 步骤 4: 测试流程

1. 打开网站，设置昵称
2. 创建新故事，设置续写人数
3. 故事立即显示在首页
4. 其他用户可以续写
5. 作者可以随时选择生成视频

---

这个方案完全满足你的需求！需要我帮你开始实施吗？

